---
title: JVMç»„æˆğŸ”¥
date: 2023-03-20
categories:
  - Java
  - JVM
tags:
  - JVM
sticky: 1
---

# 1 JVMç»„æˆ

### 1.1 JVMç”±é‚£äº›éƒ¨åˆ†ç»„æˆï¼Œè¿è¡Œæµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†â˜†

**JVMæ˜¯ä»€ä¹ˆ**

Java Virtual Machine Javaç¨‹åºçš„è¿è¡Œç¯å¢ƒï¼ˆjavaäºŒè¿›åˆ¶å­—èŠ‚ç çš„è¿è¡Œç¯å¢ƒï¼‰

å¥½å¤„ï¼š

- ä¸€æ¬¡ç¼–å†™ï¼Œåˆ°å¤„è¿è¡Œ

- è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼Œåƒåœ¾å›æ”¶æœºåˆ¶

![image-20230506094254360](./assets/image-20230506094254360.png)

**JVMç”±å“ªäº›éƒ¨åˆ†ç»„æˆï¼Œè¿è¡Œæµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ**

![image-20230506094411247](./assets/image-20230506094411247.png)

ä»å›¾ä¸­å¯ä»¥çœ‹å‡º JVM çš„ä¸»è¦ç»„æˆéƒ¨åˆ†

- ClassLoaderï¼ˆç±»åŠ è½½å™¨ï¼‰
- Runtime Data Areaï¼ˆè¿è¡Œæ—¶æ•°æ®åŒºï¼Œå†…å­˜åˆ†åŒºï¼‰
- Execution Engineï¼ˆæ‰§è¡Œå¼•æ“ï¼‰
- Native Method Libraryï¼ˆæœ¬åœ°åº“æ¥å£ï¼‰

è¿è¡Œæµç¨‹ï¼š

ï¼ˆ1ï¼‰ç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰æŠŠJavaä»£ç è½¬æ¢ä¸ºå­—èŠ‚ç 

ï¼ˆ2ï¼‰è¿è¡Œæ—¶æ•°æ®åŒºï¼ˆRuntime Data Areaï¼‰æŠŠå­—èŠ‚ç åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè€Œå­—èŠ‚ç æ–‡ä»¶åªæ˜¯JVMçš„ä¸€å¥—æŒ‡ä»¤é›†è§„èŒƒï¼Œå¹¶ä¸èƒ½ç›´æ¥äº¤ç»™åº•å±‚ç³»ç»Ÿå»æ‰§è¡Œï¼Œè€Œæ˜¯æœ‰æ‰§è¡Œå¼•æ“è¿è¡Œ

ï¼ˆ3ï¼‰æ‰§è¡Œå¼•æ“ï¼ˆExecution Engineï¼‰å°†å­—èŠ‚ç ç¿»è¯‘ä¸ºåº•å±‚ç³»ç»ŸæŒ‡ä»¤ï¼Œå†äº¤ç”±CPUæ‰§è¡Œå»æ‰§è¡Œï¼Œæ­¤æ—¶éœ€è¦è°ƒç”¨å…¶ä»–è¯­è¨€çš„æœ¬åœ°åº“æ¥å£ï¼ˆNative Method Libraryï¼‰æ¥å®ç°æ•´ä¸ªç¨‹åºçš„åŠŸèƒ½ã€‚



### 1.2 ä»€ä¹ˆæ˜¯ç¨‹åºè®¡æ•°å™¨ï¼Ÿ

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†â˜†

ç¨‹åºè®¡æ•°å™¨ï¼šçº¿ç¨‹ç§æœ‰çš„ï¼Œå†…éƒ¨ä¿å­˜çš„å­—èŠ‚ç çš„è¡Œå·ã€‚ç”¨äºè®°å½•æ­£åœ¨æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ã€‚

>javap -verbose  xx.class    æ‰“å°å †æ ˆå¤§å°ï¼Œå±€éƒ¨å˜é‡çš„æ•°é‡å’Œæ–¹æ³•çš„å‚æ•°ã€‚

![image-20230506094602329](./assets/image-20230506094602329.png)



â€‹	javaè™šæ‹Ÿæœºå¯¹äºå¤šçº¿ç¨‹æ˜¯é€šè¿‡çº¿ç¨‹è½®æµåˆ‡æ¢å¹¶ä¸”åˆ†é…çº¿ç¨‹æ‰§è¡Œæ—¶é—´ã€‚åœ¨ä»»ä½•çš„ä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œä¸€ä¸ªå¤„ç†å™¨åªä¼šå¤„ç†æ‰§è¡Œä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœå½“å‰è¢«æ‰§è¡Œçš„è¿™ä¸ªçº¿ç¨‹å®ƒæ‰€åˆ†é…çš„æ‰§è¡Œæ—¶é—´ç”¨å®Œäº†ã€æŒ‚èµ·ã€‘ã€‚å¤„ç†å™¨ä¼šåˆ‡æ¢åˆ°å¦å¤–çš„ä¸€ä¸ªçº¿ç¨‹ä¸Šæ¥è¿›è¡Œæ‰§è¡Œã€‚å¹¶ä¸”è¿™ä¸ªçº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ç”¨å®Œäº†ï¼Œæ¥ç€å¤„ç†å™¨å°±ä¼šåˆæ¥æ‰§è¡Œè¢«æŒ‚èµ·çš„è¿™ä¸ªçº¿ç¨‹ã€‚

â€‹	é‚£ä¹ˆç°åœ¨æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå½“å‰å¤„ç†å™¨å¦‚ä½•èƒ½å¤ŸçŸ¥é“ï¼Œå¯¹äºè¿™ä¸ªè¢«æŒ‚èµ·çš„çº¿ç¨‹ï¼Œå®ƒä¸Šä¸€æ¬¡æ‰§è¡Œåˆ°äº†å“ªé‡Œï¼Ÿé‚£ä¹ˆè¿™æ—¶å°±éœ€è¦ä»ç¨‹åºè®¡æ•°å™¨ä¸­æ¥å›å»åˆ°å½“å‰çš„è¿™ä¸ªçº¿ç¨‹ä»–ä¸Šä¸€æ¬¡æ‰§è¡Œçš„è¡Œå·ï¼Œç„¶åæ¥ç€ç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚

â€‹	ç¨‹åºè®¡æ•°å™¨æ˜¯JVMè§„èŒƒä¸­å”¯ä¸€ä¸€ä¸ªæ²¡æœ‰è§„å®šå‡ºç°OOMçš„åŒºåŸŸï¼Œæ‰€ä»¥è¿™ä¸ªç©ºé—´ä¹Ÿä¸ä¼šè¿›è¡ŒGCã€‚

### 1.3 ä½ èƒ½ç»™æˆ‘è¯¦ç»†çš„ä»‹ç»Javaå †å—?

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†â˜†

çº¿ç¨‹å…±äº«çš„åŒºåŸŸï¼šä¸»è¦ç”¨æ¥ä¿å­˜å¯¹è±¡å®ä¾‹ï¼Œæ•°ç»„ç­‰ï¼Œå½“å †ä¸­æ²¡æœ‰å†…å­˜ç©ºé—´å¯åˆ†é…ç»™å®ä¾‹ï¼Œä¹Ÿæ— æ³•å†æ‰©å±•æ—¶ï¼Œåˆ™æŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚

![image-20230506094803545](./assets/image-20230506094803545.png)

- å¹´è½»ä»£è¢«åˆ’åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼ŒEdenåŒºå’Œä¸¤ä¸ªå¤§å°ä¸¥æ ¼ç›¸åŒçš„SurvivoråŒºï¼Œæ ¹æ®JVMçš„ç­–ç•¥ï¼Œåœ¨ç»è¿‡å‡ æ¬¡åƒåœ¾æ”¶é›†åï¼Œä»»ç„¶å­˜æ´»äºSurvivorçš„å¯¹è±¡å°†è¢«ç§»åŠ¨åˆ°è€å¹´ä»£åŒºé—´ã€‚
- è€å¹´ä»£ä¸»è¦ä¿å­˜ç”Ÿå‘½å‘¨æœŸé•¿çš„å¯¹è±¡ï¼Œä¸€èˆ¬æ˜¯ä¸€äº›è€çš„å¯¹è±¡
- å…ƒç©ºé—´ä¿å­˜çš„ç±»ä¿¡æ¯ã€é™æ€å˜é‡ã€å¸¸é‡ã€ç¼–è¯‘åçš„ä»£ç 

â€‹	

ä¸ºäº†é¿å…æ–¹æ³•åŒºå‡ºç°OOMï¼Œæ‰€ä»¥åœ¨java8ä¸­å°†å †ä¸Šçš„æ–¹æ³•åŒºã€æ°¸ä¹…ä»£ã€‘ç»™ç§»åŠ¨åˆ°äº†æœ¬åœ°å†…å­˜ä¸Šï¼Œé‡æ–°å¼€è¾Ÿäº†ä¸€å—ç©ºé—´ï¼Œå«åš**å…ƒç©ºé—´**ã€‚é‚£ä¹ˆç°åœ¨å°±å¯ä»¥é¿å…æ‰OOMçš„å‡ºç°äº†ã€‚

![image-20230506094938843](./assets/image-20230506094938843.png)

##### å…ƒç©ºé—´(MetaSpace)ä»‹ç»

â€‹	åœ¨ HotSpot JVM ä¸­ï¼Œæ°¸ä¹…ä»£ï¼ˆ â‰ˆ æ–¹æ³•åŒºï¼‰ä¸­ç”¨äºå­˜æ”¾ç±»å’Œæ–¹æ³•çš„å…ƒæ•°æ®ä»¥åŠå¸¸é‡æ± ï¼Œæ¯”å¦‚Class å’Œ Methodã€‚æ¯å½“ä¸€ä¸ªç±»åˆæ¬¡è¢«åŠ è½½çš„æ—¶å€™ï¼Œå®ƒçš„å…ƒæ•°æ®éƒ½ä¼šæ”¾åˆ°æ°¸ä¹…ä»£ä¸­ã€‚

â€‹	æ°¸ä¹…ä»£æ˜¯æœ‰å¤§å°é™åˆ¶çš„ï¼Œå› æ­¤å¦‚æœåŠ è½½çš„ç±»å¤ªå¤šï¼Œå¾ˆæœ‰å¯èƒ½å¯¼è‡´æ°¸ä¹…ä»£å†…å­˜æº¢å‡ºï¼Œå³OutOfMemoryErrorï¼Œä¸ºæ­¤ä¸å¾—ä¸å¯¹è™šæ‹Ÿæœºåšè°ƒä¼˜ã€‚

â€‹	é‚£ä¹ˆï¼ŒJava 8 ä¸­ PermGen ä¸ºä»€ä¹ˆè¢«ç§»å‡º HotSpot JVM äº†ï¼Ÿ

å®˜ç½‘ç»™å‡ºäº†è§£é‡Šï¼šhttp://openjdk.java.net/jeps/122

~~~
This is part of the JRockit and Hotspot convergence effort. JRockit customers do not need to configure the permanent generation (since JRockit does not have a permanent generation) and are accustomed to not configuring the permanent generation.

ç§»é™¤æ°¸ä¹…ä»£æ˜¯ä¸ºèåˆHotSpot JVMä¸ JRockit VMè€Œåšå‡ºçš„åŠªåŠ›ï¼Œå› ä¸ºJRockitæ²¡æœ‰æ°¸ä¹…ä»£ï¼Œä¸éœ€è¦é…ç½®æ°¸ä¹…ä»£ã€‚
~~~

1ï¼‰ç”±äº PermGen å†…å­˜ç»å¸¸ä¼šæº¢å‡ºï¼Œå¼•å‘OutOfMemoryErrorï¼Œå› æ­¤ JVM çš„å¼€å‘è€…å¸Œæœ›è¿™ä¸€å—å†…å­˜å¯ä»¥æ›´çµæ´»åœ°è¢«ç®¡ç†ï¼Œä¸è¦å†ç»å¸¸å‡ºç°è¿™æ ·çš„ OOMã€‚

2ï¼‰ç§»é™¤ PermGen å¯ä»¥ä¿ƒè¿› HotSpot JVM ä¸ JRockit VM çš„èåˆï¼Œå› ä¸º JRockit æ²¡æœ‰æ°¸ä¹…ä»£ã€‚

â€‹	å‡†ç¡®æ¥è¯´ï¼ŒPerm åŒºä¸­çš„å­—ç¬¦ä¸²å¸¸é‡æ± è¢«ç§»åˆ°äº†å †å†…å­˜ä¸­æ˜¯åœ¨ Java7 ä¹‹åï¼ŒJava 8 æ—¶ï¼ŒPermGen è¢«å…ƒç©ºé—´ä»£æ›¿ï¼Œå…¶ä»–å†…å®¹æ¯”å¦‚**ç±»å…ƒä¿¡æ¯ã€å­—æ®µã€é™æ€å±æ€§ã€æ–¹æ³•ã€å¸¸é‡**ç­‰éƒ½ç§»åŠ¨åˆ°å…ƒç©ºé—´åŒºã€‚æ¯”å¦‚ java/lang/Object ç±»å…ƒä¿¡æ¯ã€é™æ€å±æ€§ System.outã€æ•´å‹å¸¸é‡ç­‰ã€‚

â€‹	å…ƒç©ºé—´çš„æœ¬è´¨å’Œæ°¸ä¹…ä»£ç±»ä¼¼ï¼Œéƒ½æ˜¯å¯¹ JVM è§„èŒƒä¸­æ–¹æ³•åŒºçš„å®ç°ã€‚ä¸è¿‡å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ã€‚å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶ã€‚

### 1.4 ä»€ä¹ˆæ˜¯è™šæ‹Ÿæœºæ ˆ

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†â˜†

Java Virtual machine Stacks (java è™šæ‹Ÿæœºæ ˆ)

- æ¯ä¸ªçº¿ç¨‹è¿è¡Œæ—¶æ‰€éœ€è¦çš„å†…å­˜ï¼Œç§°ä¸ºè™šæ‹Ÿæœºæ ˆï¼Œå…ˆè¿›åå‡º

- æ¯ä¸ªæ ˆç”±å¤šä¸ªæ ˆå¸§ï¼ˆframeï¼‰ç»„æˆï¼Œå¯¹åº”ç€æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å ç”¨çš„å†…å­˜

- æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„é‚£ä¸ªæ–¹æ³•

![image-20230506095140595](./assets/image-20230506095140595.png)

1. åƒåœ¾å›æ”¶æ˜¯å¦æ¶‰åŠæ ˆå†…å­˜ï¼Ÿ

   åƒåœ¾å›æ”¶ä¸»è¦æŒ‡å°±æ˜¯å †å†…å­˜ï¼Œå½“æ ˆå¸§å¼¹æ ˆä»¥åï¼Œå†…å­˜å°±ä¼šé‡Šæ”¾

2. æ ˆå†…å­˜åˆ†é…è¶Šå¤§è¶Šå¥½å—ï¼Ÿ

   æœªå¿…ï¼Œé»˜è®¤çš„æ ˆå†…å­˜é€šå¸¸ä¸º1024k

   æ ˆå¸§è¿‡å¤§ä¼šå¯¼è‡´çº¿ç¨‹æ•°å˜å°‘ï¼Œä¾‹å¦‚ï¼Œæœºå™¨æ€»å†…å­˜ä¸º512mï¼Œç›®å‰èƒ½æ´»åŠ¨çš„çº¿ç¨‹æ•°åˆ™ä¸º512ä¸ªï¼Œå¦‚æœæŠŠæ ˆå†…å­˜æ”¹ä¸º2048kï¼Œé‚£ä¹ˆèƒ½æ´»åŠ¨çš„æ ˆå¸§å°±ä¼šå‡åŠ

3. æ–¹æ³•å†…çš„å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ

   - å¦‚æœæ–¹æ³•å†…å±€éƒ¨å˜é‡æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„

   - å¦‚æœæ˜¯å±€éƒ¨å˜é‡å¼•ç”¨äº†å¯¹è±¡ï¼Œå¹¶é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨

   - æ¯”å¦‚ä»¥ä¸‹ä»£ç ï¼š

     ![image-20230506095306061](./assets/image-20230506095306061.png)

**æ ˆå†…å­˜æº¢å‡ºæƒ…å†µ**

- æ ˆå¸§è¿‡å¤šå¯¼è‡´æ ˆå†…å­˜æº¢å‡ºï¼Œå…¸å‹é—®é¢˜ï¼šé€’å½’è°ƒç”¨

  ![image-20230506095401637](./assets/image-20230506095401637.png)

- æ ˆå¸§è¿‡å¤§å¯¼è‡´æ ˆå†…å­˜æº¢å‡º

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†

ç»„æˆéƒ¨åˆ†ï¼šå †ã€æ–¹æ³•åŒºã€æ ˆã€æœ¬åœ°æ–¹æ³•æ ˆã€ç¨‹åºè®¡æ•°å™¨

1ã€å †è§£å†³çš„æ˜¯å¯¹è±¡å®ä¾‹å­˜å‚¨çš„é—®é¢˜ï¼Œåƒåœ¾å›æ”¶å™¨ç®¡ç†çš„ä¸»è¦åŒºåŸŸã€‚
2ã€æ–¹æ³•åŒºå¯ä»¥è®¤ä¸ºæ˜¯å †çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ä¿¡æ¯ï¼Œå¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ã€‚
3ã€æ ˆè§£å†³çš„æ˜¯ç¨‹åºè¿è¡Œçš„é—®é¢˜ï¼Œæ ˆé‡Œé¢å­˜çš„æ˜¯æ ˆå¸§ï¼Œæ ˆå¸§é‡Œé¢å­˜çš„æ˜¯å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚
4ã€æœ¬åœ°æ–¹æ³•æ ˆä¸æ ˆåŠŸèƒ½ç›¸åŒï¼Œæœ¬åœ°æ–¹æ³•æ ˆæ‰§è¡Œçš„æ˜¯æœ¬åœ°æ–¹æ³•ï¼Œä¸€ä¸ªJavaè°ƒç”¨éJavaä»£ç çš„æ¥å£ã€‚
5ã€ç¨‹åºè®¡æ•°å™¨ï¼ˆPCå¯„å­˜å™¨ï¼‰ç¨‹åºè®¡æ•°å™¨ä¸­å­˜æ”¾çš„æ˜¯å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œæ•°ã€‚JVMå·¥ä½œæ—¶å°±æ˜¯é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€ä¸ªéœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚



### 1.5 èƒ½ä¸èƒ½è§£é‡Šä¸€ä¸‹æ–¹æ³•åŒºï¼Ÿ

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†

#### 1.5.1 æ¦‚è¿°

- æ–¹æ³•åŒº(Method Area)æ˜¯å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸ

- ä¸»è¦å­˜å‚¨ç±»çš„ä¿¡æ¯ã€è¿è¡Œæ—¶å¸¸é‡æ± 

- è™šæ‹Ÿæœºå¯åŠ¨çš„æ—¶å€™åˆ›å»ºï¼Œå…³é—­è™šæ‹Ÿæœºæ—¶é‡Šæ”¾

- å¦‚æœæ–¹æ³•åŒºåŸŸä¸­çš„å†…å­˜æ— æ³•æ»¡è¶³åˆ†é…è¯·æ±‚ï¼Œåˆ™ä¼šæŠ›å‡ºOutOfMemoryError: Metaspace

![image-20230506095504213](./assets/image-20230506095504213.png)

#### 1.5.2 å¸¸é‡æ± 

å¯ä»¥çœ‹ä½œæ˜¯ä¸€å¼ è¡¨ï¼Œè™šæ‹ŸæœºæŒ‡ä»¤æ ¹æ®è¿™å¼ å¸¸é‡è¡¨æ‰¾åˆ°è¦æ‰§è¡Œçš„ç±»åã€æ–¹æ³•åã€å‚æ•°ç±»å‹ã€å­—é¢é‡ç­‰ä¿¡æ¯

æŸ¥çœ‹å­—èŠ‚ç ç»“æ„ï¼ˆç±»çš„åŸºæœ¬ä¿¡æ¯ã€å¸¸é‡æ± ã€æ–¹æ³•å®šä¹‰ï¼‰`javap -v xx.class`

æ¯”å¦‚ä¸‹é¢æ˜¯ä¸€ä¸ªApplicationç±»çš„mainæ–¹æ³•æ‰§è¡Œï¼Œæºç å¦‚ä¸‹ï¼š

```java
public class Application {
    public static void main(String[] args) {
        System.out.println("hello world");
    }
}
```

æ‰¾åˆ°ç±»å¯¹åº”çš„classæ–‡ä»¶å­˜æ”¾ç›®å½•ï¼Œæ‰§è¡Œå‘½ä»¤ï¼š`javap -v Application.class`   æŸ¥çœ‹å­—èŠ‚ç ç»“æ„

```java
D:\code\jvm-demo\target\classes\com\heima\jvm>javap -v Application.class
Classfile /D:/code/jvm-demo/target/classes/com/heima/jvm/Application.class
  Last modified 2023-05-07; size 564 bytes    //æœ€åä¿®æ”¹çš„æ—¶é—´
  MD5 checksum c1b64ed6491b9a16c2baab5061c64f88   //ç­¾å
  Compiled from "Application.java"   //ä»å“ªä¸ªæºç ç¼–è¯‘
public class com.heima.jvm.Application   //åŒ…åï¼Œç±»å
  minor version: 0
  major version: 52     //jdkç‰ˆæœ¬
  flags: ACC_PUBLIC, ACC_SUPER  //ä¿®é¥°ç¬¦
Constant pool:   //å¸¸é‡æ± 
   #1 = Methodref          #6.#20         // java/lang/Object."<init>":()V
   #2 = Fieldref           #21.#22        // java/lang/System.out:Ljava/io/PrintStream;
   #3 = String             #23            // hello world
   #4 = Methodref          #24.#25        // java/io/PrintStream.println:(Ljava/lang/String;)V
   #5 = Class              #26            // com/heima/jvm/Application
   #6 = Class              #27            // java/lang/Object
   #7 = Utf8               <init>
   #8 = Utf8               ()V
   #9 = Utf8               Code
  #10 = Utf8               LineNumberTable
  #11 = Utf8               LocalVariableTable
  #12 = Utf8               this
  #13 = Utf8               Lcom/heima/jvm/Application;
  #14 = Utf8               main
  #15 = Utf8               ([Ljava/lang/String;)V
  #16 = Utf8               args
  #17 = Utf8               [Ljava/lang/String;
  #18 = Utf8               SourceFile
  #19 = Utf8               Application.java
  #20 = NameAndType        #7:#8          // "<init>":()V
  #21 = Class              #28            // java/lang/System
  #22 = NameAndType        #29:#30        // out:Ljava/io/PrintStream;
  #23 = Utf8               hello world
  #24 = Class              #31            // java/io/PrintStream
  #25 = NameAndType        #32:#33        // println:(Ljava/lang/String;)V
  #26 = Utf8               com/heima/jvm/Application
  #27 = Utf8               java/lang/Object
  #28 = Utf8               java/lang/System
  #29 = Utf8               out
  #30 = Utf8               Ljava/io/PrintStream;
  #31 = Utf8               java/io/PrintStream
  #32 = Utf8               println
  #33 = Utf8               (Ljava/lang/String;)V
{
  public com.heima.jvm.Application();  //æ„é€ æ–¹æ³•
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: return
      LineNumberTable:
        line 3: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lcom/heima/jvm/Application;

  public static void main(java.lang.String[]);  //mainæ–¹æ³•
    descriptor: ([Ljava/lang/String;)V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=1, args_size=1
         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;
         3: ldc           #3                  // String hello world
         5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
         8: return
      LineNumberTable:
        line 7: 0
        line 8: 8
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       9     0  args   [Ljava/lang/String;
}
SourceFile: "Application.java"
```

ä¸‹å›¾ï¼Œå·¦ä¾§æ˜¯mainæ–¹æ³•çš„æŒ‡ä»¤ä¿¡æ¯ï¼Œå³ä¾§constant pool  æ˜¯å¸¸é‡æ± 

mainæ–¹æ³•æŒ‰ç…§æŒ‡ä»¤æ‰§è¡Œçš„æ—¶å€™ï¼Œéœ€è¦åˆ°å¸¸é‡æ± ä¸­æŸ¥è¡¨ç¿»è¯‘æ‰¾åˆ°å…·ä½“çš„ç±»å’Œæ–¹æ³•åœ°å€å»æ‰§è¡Œ

![image-20230506095634842](./assets/image-20230506095634842.png)

#### 1.5.3 è¿è¡Œæ—¶å¸¸é‡æ± 

å¸¸é‡æ± æ˜¯ *.class æ–‡ä»¶ä¸­çš„ï¼Œå½“è¯¥ç±»è¢«åŠ è½½ï¼Œå®ƒçš„å¸¸é‡æ± ä¿¡æ¯å°±ä¼šæ”¾å…¥è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œå¹¶æŠŠé‡Œé¢çš„ç¬¦å·åœ°å€å˜ä¸ºçœŸå®åœ°å€

![image-20230506100142724](./assets/image-20230506100142724.png)





### 1.6 ä½ å¬è¿‡ç›´æ¥å†…å­˜å—ï¼Ÿ

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†

ä¸å— JVM å†…å­˜å›æ”¶ç®¡ç†ï¼Œæ˜¯è™šæ‹Ÿæœºçš„ç³»ç»Ÿå†…å­˜ï¼Œå¸¸è§äº NIO æ“ä½œæ—¶ï¼Œç”¨äºæ•°æ®ç¼“å†²åŒºï¼Œåˆ†é…å›æ”¶æˆæœ¬è¾ƒé«˜ï¼Œä½†è¯»å†™æ€§èƒ½é«˜ï¼Œä¸å— JVM å†…å­˜å›æ”¶ç®¡ç†



ä¸¾ä¾‹ï¼š

éœ€æ±‚ï¼Œåœ¨æœ¬åœ°ç”µè„‘ä¸­çš„ä¸€ä¸ªè¾ƒå¤§çš„æ–‡ä»¶ï¼ˆè¶…è¿‡100mï¼‰ä»ä¸€ä¸ªç£ç›˜æŒªåˆ°å¦å¤–ä¸€ä¸ªç£ç›˜

![image-20230506100501905](./assets/image-20230506100501905.png)

ä»£ç å¦‚ä¸‹ï¼š

```java
/**
 * æ¼”ç¤º ByteBuffer ä½œç”¨
 */
public class Demo1_9 {
    static final String FROM = "E:\\ç¼–ç¨‹èµ„æ–™\\ç¬¬ä¸‰æ–¹æ•™å­¦è§†é¢‘\\youtube\\Getting Started with Spring Boot-sbPSjI4tt10.mp4";
    static final String TO = "E:\\a.mp4";
    static final int _1Mb = 1024 * 1024;

    public static void main(String[] args) {
        io(); // io ç”¨æ—¶ï¼š1535.586957 1766.963399 1359.240226
        directBuffer(); // directBuffer ç”¨æ—¶ï¼š479.295165 702.291454 562.56592
    }

    private static void directBuffer() {
        long start = System.nanoTime();
        try (FileChannel from = new FileInputStream(FROM).getChannel();
             FileChannel to = new FileOutputStream(TO).getChannel();
        ) {
            ByteBuffer bb = ByteBuffer.allocateDirect(_1Mb);
            while (true) {
                int len = from.read(bb);
                if (len == -1) {
                    break;
                }
                bb.flip();
                to.write(bb);
                bb.clear();
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
        long end = System.nanoTime();
        System.out.println("directBuffer ç”¨æ—¶ï¼š" + (end - start) / 1000_000.0);
    }

    private static void io() {
        long start = System.nanoTime();
        try (FileInputStream from = new FileInputStream(FROM);
             FileOutputStream to = new FileOutputStream(TO);
        ) {
            byte[] buf = new byte[_1Mb];
            while (true) {
                int len = from.read(buf);
                if (len == -1) {
                    break;
                }
                to.write(buf, 0, len);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
        long end = System.nanoTime();
        System.out.println("io ç”¨æ—¶ï¼š" + (end - start) / 1000_000.0);
    }
}
```

å¯ä»¥å‘ç°ï¼Œä½¿ç”¨ä¼ ç»Ÿçš„IOçš„æ—¶é—´è¦æ¯”NIOæ“ä½œçš„æ—¶é—´é•¿äº†å¾ˆå¤šäº†ï¼Œä¹Ÿå°±è¯´NIOçš„è¯»æ€§èƒ½æ›´å¥½ã€‚

è¿™ä¸ªæ˜¯è·Ÿæˆ‘ä»¬çš„JVMçš„ç›´æ¥å†…å­˜æ˜¯æœ‰ä¸€å®šå…³ç³»ï¼Œå¦‚ä¸‹å›¾ï¼Œæ˜¯ä¼ ç»Ÿé˜»å¡IOçš„æ•°æ®ä¼ è¾“æµç¨‹

![image-20230506100548455](./assets/image-20230506100548455.png)

ä¸‹å›¾æ˜¯NIOä¼ è¾“æ•°æ®çš„æµç¨‹ï¼Œåœ¨è¿™ä¸ªé‡Œé¢ä¸»è¦ä½¿ç”¨åˆ°äº†ä¸€ä¸ªç›´æ¥å†…å­˜ï¼Œä¸éœ€è¦åœ¨å †ä¸­å¼€è¾Ÿç©ºé—´è¿›è¡Œæ•°æ®çš„æ‹·è´ï¼Œjvmå¯ä»¥ç›´æ¥æ“ä½œç›´æ¥å†…å­˜ï¼Œä»è€Œä½¿æ•°æ®è¯»å†™ä¼ è¾“æ›´å¿«ã€‚

![image-20230506100621146](./assets/image-20230506100621146.png)



### 1.7 å †æ ˆçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†â˜†

1ã€æ ˆå†…å­˜ä¸€èˆ¬ä¼šç”¨æ¥å­˜å‚¨å±€éƒ¨å˜é‡å’Œæ–¹æ³•è°ƒç”¨ï¼Œä½†å †å†…å­˜æ˜¯ç”¨æ¥å­˜å‚¨Javaå¯¹è±¡å’Œæ•°ç»„çš„çš„ã€‚å †ä¼šGCåƒåœ¾å›æ”¶ï¼Œè€Œæ ˆä¸ä¼šã€‚

2ã€æ ˆå†…å­˜æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œè€Œå †å†…å­˜æ˜¯çº¿ç¨‹å…±æœ‰çš„ã€‚

3,ã€ä¸¤è€…å¼‚å¸¸é”™è¯¯ä¸åŒï¼Œä½†å¦‚æœæ ˆå†…å­˜æˆ–è€…å †å†…å­˜ä¸è¶³éƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

æ ˆç©ºé—´ä¸è¶³ï¼šjava.lang.StackOverFlowErrorã€‚

å †ç©ºé—´ä¸è¶³ï¼šjava.lang.OutOfMemoryErrorã€‚

## 2 ç±»åŠ è½½å™¨

### 2.1 ä»€ä¹ˆæ˜¯ç±»åŠ è½½å™¨ï¼Œç±»åŠ è½½å™¨æœ‰å“ªäº›?

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†

è¦æƒ³ç†è§£ç±»åŠ è½½å™¨çš„è¯ï¼ŒåŠ¡å¿…è¦å…ˆæ¸…æ¥šå¯¹äºä¸€ä¸ªJavaæ–‡ä»¶ï¼Œå®ƒä»ç¼–è¯‘åˆ°æ‰§è¡Œçš„æ•´ä¸ªè¿‡ç¨‹ã€‚

![](./assets/image-20220903233627146.png)

- ç±»åŠ è½½å™¨ï¼šç”¨äºè£…è½½å­—èŠ‚ç æ–‡ä»¶(.classæ–‡ä»¶)
- è¿è¡Œæ—¶æ•°æ®åŒºï¼šç”¨äºåˆ†é…å­˜å‚¨ç©ºé—´
- æ‰§è¡Œå¼•æ“ï¼šæ‰§è¡Œå­—èŠ‚ç æ–‡ä»¶æˆ–æœ¬åœ°æ–¹æ³•
- åƒåœ¾å›æ”¶å™¨ï¼šç”¨äºå¯¹JVMä¸­çš„åƒåœ¾å†…å®¹è¿›è¡Œå›æ”¶

**ç±»åŠ è½½å™¨**

JVMåªä¼šè¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰çš„ä¸»è¦ä½œç”¨å°±æ˜¯å°†**å­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°JVMä¸­**ï¼Œä»è€Œè®©Javaç¨‹åºèƒ½å¤Ÿå¯åŠ¨èµ·æ¥ã€‚ç°æœ‰çš„ç±»åŠ è½½å™¨åŸºæœ¬ä¸Šéƒ½æ˜¯java.lang.ClassLoaderçš„å­ç±»ï¼Œè¯¥ç±»çš„åªè¦èŒè´£å°±æ˜¯ç”¨äºå°†æŒ‡å®šçš„ç±»æ‰¾åˆ°æˆ–ç”Ÿæˆå¯¹åº”çš„å­—èŠ‚ç æ–‡ä»¶ï¼ŒåŒæ—¶ç±»åŠ è½½å™¨è¿˜ä¼šè´Ÿè´£åŠ è½½ç¨‹åºæ‰€éœ€è¦çš„èµ„æº

**ç±»åŠ è½½å™¨ç§ç±»**

ç±»åŠ è½½å™¨æ ¹æ®å„è‡ªåŠ è½½èŒƒå›´çš„ä¸åŒï¼Œåˆ’åˆ†ä¸ºå››ç§ç±»åŠ è½½å™¨ï¼š

- **å¯åŠ¨ç±»åŠ è½½å™¨(BootStrap ClassLoader)ï¼š**

  è¯¥ç±»å¹¶ä¸ç»§æ‰¿ClassLoaderç±»ï¼Œå…¶æ˜¯ç”±C++ç¼–å†™å®ç°ã€‚ç”¨äºåŠ è½½**JAVA_HOME/jre/lib**ç›®å½•ä¸‹çš„ç±»åº“ã€‚

- **æ‰©å±•ç±»åŠ è½½å™¨(ExtClassLoader)ï¼š**

  è¯¥ç±»æ˜¯ClassLoaderçš„å­ç±»ï¼Œä¸»è¦åŠ è½½**JAVA_HOME/jre/lib/ext**ç›®å½•ä¸­çš„ç±»åº“ã€‚

- **åº”ç”¨ç±»åŠ è½½å™¨(AppClassLoader)ï¼š**

  è¯¥ç±»æ˜¯ClassLoaderçš„å­ç±»ï¼Œä¸»è¦ç”¨äºåŠ è½½**classPath**ä¸‹çš„ç±»ï¼Œä¹Ÿå°±æ˜¯åŠ è½½å¼€å‘è€…è‡ªå·±ç¼–å†™çš„Javaç±»ã€‚

- **è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼š**

  å¼€å‘è€…è‡ªå®šä¹‰ç±»ç»§æ‰¿ClassLoaderï¼Œå®ç°è‡ªå®šä¹‰ç±»åŠ è½½è§„åˆ™ã€‚

ä¸Šè¿°ä¸‰ç§ç±»åŠ è½½å™¨çš„å±‚æ¬¡ç»“æ„å¦‚ä¸‹å¦‚ä¸‹ï¼š

![image-20230506100746624](./assets/image-20230506100746624.png)

ç±»åŠ è½½å™¨çš„ä½“ç³»å¹¶ä¸æ˜¯â€œç»§æ‰¿â€ä½“ç³»ï¼Œè€Œæ˜¯**å§”æ´¾ä½“ç³»**ï¼Œç±»åŠ è½½å™¨é¦–å…ˆä¼šåˆ°è‡ªå·±çš„parentä¸­æŸ¥æ‰¾ç±»æˆ–è€…èµ„æºï¼Œå¦‚æœæ‰¾ä¸åˆ°æ‰ä¼šåˆ°è‡ªå·±æœ¬åœ°æŸ¥æ‰¾ã€‚ç±»åŠ è½½å™¨çš„å§”æ‰˜è¡Œä¸ºåŠ¨æœºæ˜¯ä¸ºäº†é¿å…ç›¸åŒçš„ç±»è¢«åŠ è½½å¤šæ¬¡ã€‚

### 2.2 ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿ

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†â˜†

å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨åœ¨æ¥åˆ°åŠ è½½ç±»çš„è¯·æ±‚æ—¶ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å°è¯•å»åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚ä»»åŠ¡å§”æ‰˜ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼Œä¾æ¬¡é€’å½’ï¼Œå¦‚æœçˆ¶ç±»åŠ è½½å™¨å¯ä»¥å®Œæˆç±»åŠ è½½ä»»åŠ¡ï¼Œå°±è¿”å›æˆåŠŸï¼›åªæœ‰çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®Œæˆæ­¤åŠ è½½ä»»åŠ¡æ—¶ï¼Œæ‰ç”±ä¸‹ä¸€çº§å»åŠ è½½ã€‚ 

![image-20230506100920042](./assets/image-20230506100920042.png)

### 2.3 JVMä¸ºä»€ä¹ˆé‡‡ç”¨åŒäº²å§”æ´¾æœºåˆ¶

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†

ï¼ˆ1ï¼‰é€šè¿‡åŒäº²å§”æ´¾æœºåˆ¶å¯ä»¥é¿å…æŸä¸€ä¸ªç±»è¢«é‡å¤åŠ è½½ï¼Œå½“çˆ¶ç±»å·²ç»åŠ è½½ååˆ™æ— éœ€é‡å¤åŠ è½½ï¼Œä¿è¯å”¯ä¸€æ€§ã€‚

ï¼ˆ2ï¼‰ä¸ºäº†å®‰å…¨ï¼Œä¿è¯ç±»åº“APIä¸ä¼šè¢«ä¿®æ”¹

åœ¨å·¥ç¨‹ä¸­æ–°å»ºjava.langåŒ…ï¼Œæ¥ç€åœ¨è¯¥åŒ…ä¸‹æ–°å»ºStringç±»ï¼Œå¹¶å®šä¹‰mainå‡½æ•°

```java
public class String {

    public static void main(String[] args) {

        System.out.println("demo info");
    }
}
```

â€‹	æ­¤æ—¶æ‰§è¡Œmainå‡½æ•°ï¼Œä¼šå‡ºç°å¼‚å¸¸ï¼Œåœ¨ç±» java.lang.String ä¸­æ‰¾ä¸åˆ° main æ–¹æ³•

![image-20220903144547378](./assets/image-20220903144547378.png)

â€‹	å‡ºç°è¯¥ä¿¡æ¯æ˜¯å› ä¸ºç”±åŒäº²å§”æ´¾çš„æœºåˆ¶ï¼Œjava.lang.Stringçš„åœ¨å¯åŠ¨ç±»åŠ è½½å™¨(Bootstrap classLoader)å¾—åˆ°åŠ è½½ï¼Œå› ä¸ºåœ¨æ ¸å¿ƒjreåº“ä¸­æœ‰å…¶ç›¸åŒåå­—çš„ç±»æ–‡ä»¶ï¼Œä½†è¯¥ç±»ä¸­å¹¶æ²¡æœ‰mainæ–¹æ³•ã€‚è¿™æ ·å°±èƒ½é˜²æ­¢æ¶æ„ç¯¡æ”¹æ ¸å¿ƒAPIåº“ã€‚

### 2.4 è¯´ä¸€ä¸‹ç±»è£…è½½çš„æ‰§è¡Œè¿‡ç¨‹ï¼Ÿ

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†

ç±»ä»åŠ è½½åˆ°è™šæ‹Ÿæœºä¸­å¼€å§‹ï¼Œç›´åˆ°å¸è½½ä¸ºæ­¢ï¼Œå®ƒçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬äº†ï¼šåŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€è§£æã€åˆå§‹åŒ–ã€ä½¿ç”¨å’Œå¸è½½è¿™7ä¸ªé˜¶æ®µã€‚å…¶ä¸­ï¼ŒéªŒè¯ã€å‡†å¤‡å’Œè§£æè¿™ä¸‰ä¸ªéƒ¨åˆ†ç»Ÿç§°ä¸ºè¿æ¥ï¼ˆlinkingï¼‰ã€‚

![image-20230506101032605](./assets/image-20230506101032605.png)

**ç±»åŠ è½½è¿‡ç¨‹è¯¦è§£**

1.åŠ è½½

![image-20230506101115674](./assets/image-20230506101115674.png) 

- é€šè¿‡ç±»çš„å…¨åï¼Œè·å–ç±»çš„äºŒè¿›åˆ¶æ•°æ®æµã€‚

- è§£æç±»çš„äºŒè¿›åˆ¶æ•°æ®æµä¸ºæ–¹æ³•åŒºå†…çš„æ•°æ®ç»“æ„ï¼ˆJavaç±»æ¨¡å‹ï¼‰ 

- åˆ›å»ºjava.lang.Classç±»çš„å®ä¾‹ï¼Œè¡¨ç¤ºè¯¥ç±»å‹ã€‚ä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£

![image-20230506101213373](./assets/image-20230506101213373.png)

2.éªŒè¯

![image-20230506101420202](./assets/image-20230506101420202.png)

**éªŒè¯ç±»æ˜¯å¦ç¬¦åˆJVMè§„èŒƒï¼Œå®‰å…¨æ€§æ£€æŸ¥**

(1)æ–‡ä»¶æ ¼å¼éªŒè¯:æ˜¯å¦ç¬¦åˆClassæ–‡ä»¶çš„è§„èŒƒ
(2)å…ƒæ•°æ®éªŒè¯
	è¿™ä¸ªç±»æ˜¯å¦æœ‰çˆ¶ç±»ï¼ˆé™¤äº†Objectè¿™ä¸ªç±»ä¹‹å¤–ï¼Œå…¶ä½™çš„ç±»éƒ½åº”è¯¥æœ‰çˆ¶ç±»ï¼‰
	è¿™ä¸ªç±»æ˜¯å¦ç»§æ‰¿ï¼ˆextendsï¼‰äº†è¢«finalä¿®é¥°è¿‡çš„ç±»ï¼ˆè¢«finalä¿®é¥°è¿‡çš„ç±»è¡¨ç¤ºç±»ä¸èƒ½è¢«ç»§æ‰¿ï¼‰
	ç±»ä¸­çš„å­—æ®µã€æ–¹æ³•æ˜¯å¦ä¸çˆ¶ç±»äº§ç”ŸçŸ›ç›¾ã€‚ï¼ˆè¢«finalä¿®é¥°è¿‡çš„æ–¹æ³•æˆ–å­—æ®µæ˜¯ä¸èƒ½è¦†ç›–çš„ï¼‰						
(3)å­—èŠ‚ç éªŒè¯
	ä¸»è¦çš„ç›®çš„æ˜¯é€šè¿‡å¯¹æ•°æ®æµå’Œæ§åˆ¶æµçš„åˆ†æï¼Œç¡®å®šç¨‹åºè¯­ä¹‰æ˜¯åˆæ³•çš„ã€ç¬¦åˆé€»è¾‘çš„ã€‚
(4)ç¬¦å·å¼•ç”¨éªŒè¯ï¼šç¬¦å·å¼•ç”¨ä»¥ä¸€ç»„ç¬¦å·æ¥æè¿°æ‰€å¼•ç”¨çš„ç›®æ ‡ï¼Œç¬¦å·å¯ä»¥æ˜¯ä»»ä½•å½¢å¼çš„å­—é¢é‡

>æ¯”å¦‚ï¼šint i = 3;
>å­—é¢é‡ï¼š3
>ç¬¦å·å¼•ç”¨ï¼ši

3.å‡†å¤‡

![image-20230506101445898](./assets/image-20230506101445898.png)

**ä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®ç±»å˜é‡åˆå§‹å€¼**

- staticå˜é‡ï¼Œåˆ†é…ç©ºé—´åœ¨å‡†å¤‡é˜¶æ®µå®Œæˆï¼ˆè®¾ç½®é»˜è®¤å€¼ï¼‰ï¼Œèµ‹å€¼åœ¨åˆå§‹åŒ–é˜¶æ®µå®Œæˆ

- staticå˜é‡æ˜¯finalçš„åŸºæœ¬ç±»å‹ï¼Œä»¥åŠå­—ç¬¦ä¸²å¸¸é‡ï¼Œå€¼å·²ç¡®å®šï¼Œèµ‹å€¼åœ¨å‡†å¤‡é˜¶æ®µå®Œæˆ

- staticå˜é‡æ˜¯finalçš„å¼•ç”¨ç±»å‹ï¼Œé‚£ä¹ˆèµ‹å€¼ä¹Ÿä¼šåœ¨åˆå§‹åŒ–é˜¶æ®µå®Œæˆ

![image-20230506101824622](./assets/image-20230506101824622.png)

4.è§£æ

![image-20230506101504632](./assets/image-20230506101504632.png)

**æŠŠç±»ä¸­çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨**

æ¯”å¦‚ï¼šæ–¹æ³•ä¸­è°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œæ–¹æ³•åå¯ä»¥ç†è§£ä¸ºç¬¦å·å¼•ç”¨ï¼Œè€Œç›´æ¥å¼•ç”¨å°±æ˜¯ä½¿ç”¨æŒ‡é’ˆç›´æ¥æŒ‡å‘æ–¹æ³•ã€‚

![image-20230506102311951](./assets/image-20230506102311951.png)

5.åˆå§‹åŒ–

![image-20230506101625087](./assets/image-20230506101625087.png)

**å¯¹ç±»çš„é™æ€å˜é‡ï¼Œé™æ€ä»£ç å—æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ**

- å¦‚æœåˆå§‹åŒ–ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå…¶çˆ¶ç±»å°šæœªåˆå§‹åŒ–ï¼Œåˆ™ä¼˜å…ˆåˆå§‹åŒ–å…¶çˆ¶ç±»ã€‚

- å¦‚æœåŒæ—¶åŒ…å«å¤šä¸ªé™æ€å˜é‡å’Œé™æ€ä»£ç å—ï¼Œåˆ™æŒ‰ç…§è‡ªä¸Šè€Œä¸‹çš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚

6.ä½¿ç”¨

![image-20230506101641837](./assets/image-20230506101641837.png)

JVM å¼€å§‹ä»å…¥å£æ–¹æ³•å¼€å§‹æ‰§è¡Œç”¨æˆ·çš„ç¨‹åºä»£ç 

- è°ƒç”¨é™æ€ç±»æˆå‘˜ä¿¡æ¯ï¼ˆæ¯”å¦‚ï¼šé™æ€å­—æ®µã€é™æ€æ–¹æ³•ï¼‰

- ä½¿ç”¨newå…³é”®å­—ä¸ºå…¶åˆ›å»ºå¯¹è±¡å®ä¾‹

7.å¸è½½

å½“ç”¨æˆ·ç¨‹åºä»£ç æ‰§è¡Œå®Œæ¯•åï¼ŒJVM ä¾¿å¼€å§‹é”€æ¯åˆ›å»ºçš„ Class å¯¹è±¡ï¼Œæœ€åè´Ÿè´£è¿è¡Œçš„ JVM ä¹Ÿé€€å‡ºå†…å­˜



## 3 åƒåœ¾æ”¶å›

### 3.1 ç®€è¿°Javaåƒåœ¾å›æ”¶æœºåˆ¶ï¼Ÿï¼ˆGCæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦GCï¼‰

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†

ä¸ºäº†è®©ç¨‹åºå‘˜æ›´ä¸“æ³¨äºä»£ç çš„å®ç°ï¼Œè€Œä¸ç”¨è¿‡å¤šçš„è€ƒè™‘å†…å­˜é‡Šæ”¾çš„é—®é¢˜ï¼Œæ‰€ä»¥ï¼Œåœ¨Javaè¯­è¨€ä¸­ï¼Œæœ‰äº†è‡ªåŠ¨çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„GC(Garbage Collection)ã€‚

æœ‰äº†åƒåœ¾å›æ”¶æœºåˆ¶åï¼Œç¨‹åºå‘˜åªéœ€è¦å…³å¿ƒå†…å­˜çš„ç”³è¯·å³å¯ï¼Œå†…å­˜çš„é‡Šæ”¾ç”±ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«å®Œæˆã€‚

åœ¨è¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œä¸åŒçš„å¯¹è±¡å¼•ç”¨ç±»å‹ï¼ŒGCä¼šé‡‡ç”¨ä¸åŒçš„å›æ”¶æ—¶æœº



æ¢å¥è¯è¯´ï¼Œè‡ªåŠ¨çš„åƒåœ¾å›æ”¶çš„ç®—æ³•å°±ä¼šå˜å¾—éå¸¸é‡è¦äº†ï¼Œå¦‚æœå› ä¸ºç®—æ³•çš„ä¸åˆç†ï¼Œå¯¼è‡´å†…å­˜èµ„æºä¸€ç›´æ²¡æœ‰é‡Šæ”¾ï¼ŒåŒæ ·ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºçš„ã€‚

å½“ç„¶ï¼Œé™¤äº†Javaè¯­è¨€ï¼ŒC#ã€Pythonç­‰è¯­è¨€ä¹Ÿéƒ½æœ‰è‡ªåŠ¨çš„åƒåœ¾å›æ”¶æœºåˆ¶ã€‚



### 3.2 å¯¹è±¡ä»€ä¹ˆæ—¶å€™å¯ä»¥è¢«åƒåœ¾å™¨å›æ”¶

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†â˜†

![image-20230506104954777](./assets/image-20230506104954777.png)

ç®€å•ä¸€å¥å°±æ˜¯ï¼šå¦‚æœä¸€ä¸ªæˆ–å¤šä¸ªå¯¹è±¡æ²¡æœ‰ä»»ä½•çš„å¼•ç”¨æŒ‡å‘å®ƒäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡ç°åœ¨å°±æ˜¯åƒåœ¾ï¼Œå¦‚æœå®šä½äº†åƒåœ¾ï¼Œåˆ™æœ‰å¯èƒ½ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚

å¦‚æœè¦å®šä½ä»€ä¹ˆæ˜¯åƒåœ¾ï¼Œæœ‰ä¸¤ç§æ–¹å¼æ¥ç¡®å®šï¼Œç¬¬ä¸€ä¸ªæ˜¯å¼•ç”¨è®¡æ•°æ³•ï¼Œç¬¬äºŒä¸ªæ˜¯å¯è¾¾æ€§åˆ†æç®—æ³•

#### 3.2.1 å¼•ç”¨è®¡æ•°æ³•

ä¸€ä¸ªå¯¹è±¡è¢«å¼•ç”¨äº†ä¸€æ¬¡ï¼Œåœ¨å½“å‰çš„å¯¹è±¡å¤´ä¸Šé€’å¢ä¸€æ¬¡å¼•ç”¨æ¬¡æ•°ï¼Œå¦‚æœè¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨æ¬¡æ•°ä¸º0ï¼Œä»£è¡¨è¿™ä¸ªå¯¹è±¡å¯å›æ”¶

```java
String demo = new String("123");
```

![image-20230506111102825](./assets/image-20230506111102825.png)

```java
String demo = null;
```

![image-20230506111136231](./assets/image-20230506111136231.png)

å½“å¯¹è±¡é—´å‡ºç°äº†å¾ªç¯å¼•ç”¨çš„è¯ï¼Œåˆ™å¼•ç”¨è®¡æ•°æ³•å°±ä¼šå¤±æ•ˆ

![image-20230506111255401](./assets/image-20230506111255401.png)

å…ˆæ‰§è¡Œå³ä¾§ä»£ç çš„å‰4è¡Œä»£ç 

![image-20230506111327590](./assets/image-20230506111327590.png)

ç›®å‰ä¸Šæ–¹çš„å¼•ç”¨å…³ç³»å’Œè®¡æ•°éƒ½æ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯ï¼Œå¦‚æœä»£ç ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œå¦‚ä¸‹å›¾

![image-20230506111512450](./assets/image-20230506111512450.png)

è™½ç„¶aå’Œbéƒ½ä¸ºnullï¼Œä½†æ˜¯ç”±äºaå’Œbå­˜åœ¨å¾ªç¯å¼•ç”¨ï¼Œè¿™æ ·aå’Œbæ°¸è¿œéƒ½ä¸ä¼šè¢«å›æ”¶ã€‚

ä¼˜ç‚¹ï¼š

- å®æ—¶æ€§è¾ƒé«˜ï¼Œæ— éœ€ç­‰åˆ°å†…å­˜ä¸å¤Ÿçš„æ—¶å€™ï¼Œæ‰å¼€å§‹å›æ”¶ï¼Œè¿è¡Œæ—¶æ ¹æ®å¯¹è±¡çš„è®¡æ•°å™¨æ˜¯å¦ä¸º0ï¼Œå°±å¯ä»¥ç›´æ¥å›æ”¶ã€‚
- åœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨æ— éœ€æŒ‚èµ·ã€‚å¦‚æœç”³è¯·å†…å­˜æ—¶ï¼Œå†…å­˜ä¸è¶³ï¼Œåˆ™ç«‹åˆ»æŠ¥OOMé”™è¯¯ã€‚
- åŒºåŸŸæ€§ï¼Œæ›´æ–°å¯¹è±¡çš„è®¡æ•°å™¨æ—¶ï¼Œåªæ˜¯å½±å“åˆ°è¯¥å¯¹è±¡ï¼Œä¸ä¼šæ‰«æå…¨éƒ¨å¯¹è±¡ã€‚

ç¼ºç‚¹ï¼š

- æ¯æ¬¡å¯¹è±¡è¢«å¼•ç”¨æ—¶ï¼Œéƒ½éœ€è¦å»æ›´æ–°è®¡æ•°å™¨ï¼Œæœ‰ä¸€ç‚¹æ—¶é—´å¼€é”€ã€‚ 
- **æµªè´¹CPUèµ„æº**ï¼Œå³ä½¿å†…å­˜å¤Ÿç”¨ï¼Œä»ç„¶åœ¨è¿è¡Œæ—¶è¿›è¡Œè®¡æ•°å™¨çš„ç»Ÿè®¡ã€‚
- **æ— æ³•è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œä¼šå¼•å‘å†…å­˜æ³„éœ²**ã€‚ï¼ˆæœ€å¤§çš„ç¼ºç‚¹ï¼‰ 

#### 3.2.2 å¯è¾¾æ€§åˆ†æç®—æ³•

â€‹	ç°åœ¨çš„è™šæ‹Ÿæœºé‡‡ç”¨çš„éƒ½æ˜¯é€šè¿‡å¯è¾¾æ€§åˆ†æç®—æ³•æ¥ç¡®å®šå“ªäº›å†…å®¹æ˜¯åƒåœ¾ã€‚

â€‹	ä¼šå­˜åœ¨ä¸€ä¸ªæ ¹èŠ‚ç‚¹ã€GC Rootsã€‘ï¼Œå¼•å‡ºå®ƒä¸‹é¢æŒ‡å‘çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå†ä»¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹èŠ‚ç‚¹å¼€å§‹æ‰¾å‡ºå®ƒä¸‹é¢çš„èŠ‚ç‚¹ï¼Œä¾æ¬¡å¾€ä¸‹ç±»æ¨ã€‚ç›´åˆ°æ‰€æœ‰çš„èŠ‚ç‚¹å…¨éƒ¨éå†å®Œæ¯•ã€‚

>æ ¹å¯¹è±¡æ˜¯é‚£äº›è‚¯å®šä¸èƒ½å½“åšåƒåœ¾å›æ”¶çš„å¯¹è±¡ï¼Œå°±å¯ä»¥å½“åšæ ¹å¯¹è±¡
>
>å±€éƒ¨å˜é‡ï¼Œé™æ€æ–¹æ³•ï¼Œé™æ€å˜é‡ï¼Œç±»ä¿¡æ¯
>
>æ ¸å¿ƒæ˜¯ï¼šåˆ¤æ–­æŸå¯¹è±¡æ˜¯å¦ä¸æ ¹å¯¹è±¡æœ‰ç›´æ¥æˆ–é—´æ¥çš„å¼•ç”¨ï¼Œå¦‚æœæ²¡æœ‰è¢«å¼•ç”¨ï¼Œåˆ™å¯ä»¥å½“åšåƒåœ¾å›æ”¶

![image-20220904010634153](./assets/image-20220904010634153.png)

â€‹	X,Yè¿™ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯å¯å›æ”¶çš„ï¼Œä½†æ˜¯**å¹¶ä¸ä¼šé©¬ä¸Šçš„è¢«å›æ”¶ï¼ï¼** å¯¹è±¡ä¸­å­˜åœ¨ä¸€ä¸ªæ–¹æ³•ã€finalizeã€‘ã€‚å½“å¯¹è±¡è¢«æ ‡è®°ä¸ºå¯å›æ”¶åï¼Œå½“å‘ç”ŸGCæ—¶ï¼Œé¦–å…ˆ**ä¼šåˆ¤æ–­è¿™ä¸ªå¯¹è±¡æ˜¯å¦æ‰§è¡Œäº†finalizeæ–¹æ³•**ï¼Œå¦‚æœè¿™ä¸ªæ–¹æ³•è¿˜æ²¡æœ‰è¢«æ‰§è¡Œçš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šå…ˆæ¥æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œæ¥ç€åœ¨è¿™ä¸ªæ–¹æ³•æ‰§è¡Œä¸­ï¼Œå¯ä»¥è®¾ç½®å½“å‰è¿™ä¸ªå¯¹è±¡ä¸GC ROOTSäº§ç”Ÿå…³è”ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•æ‰§è¡Œå®Œæˆä¹‹åï¼ŒGCä¼šå†æ¬¡åˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯è¾¾ï¼Œå¦‚æœä»ç„¶ä¸å¯è¾¾ï¼Œåˆ™ä¼šè¿›è¡Œå›æ”¶ï¼Œå¦‚æœå¯è¾¾äº†ï¼Œåˆ™ä¸ä¼šè¿›è¡Œå›æ”¶ã€‚

â€‹	finalizeæ–¹æ³•å¯¹äºæ¯ä¸€ä¸ªå¯¹è±¡æ¥è¯´ï¼Œåªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚å¦‚æœç¬¬ä¸€æ¬¡æ‰§è¡Œè¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œè®¾ç½®äº†å½“å‰å¯¹è±¡ä¸RC ROOTSå…³è”ï¼Œé‚£ä¹ˆè¿™ä¸€æ¬¡ä¸ä¼šè¿›è¡Œå›æ”¶ã€‚ é‚£ä¹ˆç­‰åˆ°è¿™ä¸ªå¯¹è±¡ç¬¬äºŒæ¬¡è¢«æ ‡è®°ä¸ºå¯å›æ”¶æ—¶ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡çš„finalizeæ–¹æ³•å°±ä¸ä¼šå†æ¬¡æ‰§è¡Œäº†ã€‚

**GC ROOTSï¼š**

- è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰ä¸­å¼•ç”¨çš„å¯¹è±¡

```java
/**
 * demoæ˜¯æ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡ï¼Œå½“ demo = null æ—¶ï¼Œç”±äºæ­¤æ—¶ demo å……å½“äº† GC Root çš„ä½œç”¨ï¼Œdemoä¸åŸæ¥æŒ‡å‘çš„å®ä¾‹ new Demo() æ–­å¼€äº†è¿æ¥ï¼Œå¯¹è±¡è¢«å›æ”¶ã€‚
 */
public class Demo {
    public static  void main(String[] args) {
    	Demo demo = new Demo();
    	demo = null;
    }
}
```

- æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡

```java
/**
 * å½“æ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡ b = null æ—¶ï¼Œç”±äº b åŸæ¥æŒ‡å‘çš„å¯¹è±¡ä¸ GC Root (å˜é‡ b) æ–­å¼€äº†è¿æ¥ï¼Œæ‰€ä»¥ b åŸæ¥æŒ‡å‘çš„å¯¹è±¡ä¼šè¢«å›æ”¶ï¼Œè€Œç”±äºæˆ‘ä»¬ç»™ a èµ‹å€¼äº†å˜é‡çš„å¼•ç”¨ï¼Œaåœ¨æ­¤æ—¶æ˜¯ç±»é™æ€å±æ€§å¼•ç”¨ï¼Œå……å½“äº† GC Root çš„ä½œç”¨ï¼Œå®ƒæŒ‡å‘çš„å¯¹è±¡ä¾ç„¶å­˜æ´»!
 */
public class Demo {
    public static Demo a;
    public static  void main(String[] args) {
        Demo b = new Demo();
        b.a = new Demo();
        b = null;
    }
}
```

- æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡

```java
/**
 * å¸¸é‡ a æŒ‡å‘çš„å¯¹è±¡å¹¶ä¸ä¼šå› ä¸º demo æŒ‡å‘çš„å¯¹è±¡è¢«å›æ”¶è€Œå›æ”¶
 */
public class Demo {
    
    public static final Demo a = new Demo();
    
    public static  void main(String[] args) {
        Demo demo = new Demo();
        demo = null;
    }
}
```

- æœ¬åœ°æ–¹æ³•æ ˆä¸­ JNIï¼ˆå³ä¸€èˆ¬è¯´çš„ Native æ–¹æ³•ï¼‰å¼•ç”¨çš„å¯¹è±¡

### 3.3 JVM åƒåœ¾å›æ”¶ç®—æ³•æœ‰å“ªäº›ï¼Ÿ

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†â˜†

#### 3.3.1 æ ‡è®°æ¸…é™¤ç®—æ³•

æ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œæ˜¯å°†åƒåœ¾å›æ”¶åˆ†ä¸º2ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯**æ ‡è®°å’Œæ¸…é™¤**ã€‚

1.æ ¹æ®å¯è¾¾æ€§åˆ†æç®—æ³•å¾—å‡ºçš„åƒåœ¾è¿›è¡Œæ ‡è®°

2.å¯¹è¿™äº›æ ‡è®°ä¸ºå¯å›æ”¶çš„å†…å®¹è¿›è¡Œåƒåœ¾å›æ”¶

![image-20230506112047190](./assets/image-20230506112047190.png)

å¯ä»¥çœ‹åˆ°ï¼Œæ ‡è®°æ¸…é™¤ç®—æ³•è§£å†³äº†å¼•ç”¨è®¡æ•°ç®—æ³•ä¸­çš„å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œæ²¡æœ‰ä»rootèŠ‚ç‚¹å¼•ç”¨çš„å¯¹è±¡éƒ½ä¼šè¢«å›æ”¶ã€‚

åŒæ ·ï¼Œæ ‡è®°æ¸…é™¤ç®—æ³•ä¹Ÿæ˜¯æœ‰ç¼ºç‚¹çš„ï¼š

- æ•ˆç‡è¾ƒä½ï¼Œ**æ ‡è®°å’Œæ¸…é™¤ä¸¤ä¸ªåŠ¨ä½œéƒ½éœ€è¦éå†æ‰€æœ‰çš„å¯¹è±¡**ï¼Œå¹¶ä¸”åœ¨GCæ—¶ï¼Œ**éœ€è¦åœæ­¢åº”ç”¨ç¨‹åº**ï¼Œå¯¹äºäº¤äº’æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„åº”ç”¨è€Œè¨€è¿™ä¸ªä½“éªŒæ˜¯éå¸¸å·®çš„ã€‚
- ï¼ˆ**é‡è¦**ï¼‰é€šè¿‡æ ‡è®°æ¸…é™¤ç®—æ³•æ¸…ç†å‡ºæ¥çš„å†…å­˜ï¼Œç¢ç‰‡åŒ–è¾ƒä¸ºä¸¥é‡ï¼Œå› ä¸ºè¢«å›æ”¶çš„å¯¹è±¡å¯èƒ½å­˜åœ¨äºå†…å­˜çš„å„ä¸ªè§’è½ï¼Œæ‰€ä»¥æ¸…ç†å‡ºæ¥çš„å†…å­˜æ˜¯ä¸è¿è´¯çš„ã€‚

#### 3.3.2 å¤åˆ¶ç®—æ³•

â€‹	å¤åˆ¶ç®—æ³•çš„æ ¸å¿ƒå°±æ˜¯ï¼Œ**å°†åŸæœ‰çš„å†…å­˜ç©ºé—´ä¸€åˆ†ä¸ºäºŒï¼Œæ¯æ¬¡åªç”¨å…¶ä¸­çš„ä¸€å—**ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶ï¼Œå°†æ­£åœ¨ä½¿ç”¨çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€ä¸ªå†…å­˜ç©ºé—´ä¸­ï¼Œç„¶åå°†è¯¥å†…å­˜ç©ºé—´æ¸…ç©ºï¼Œäº¤æ¢ä¸¤ä¸ªå†…å­˜çš„è§’è‰²ï¼Œå®Œæˆåƒåœ¾çš„å›æ”¶ã€‚

â€‹	å¦‚æœå†…å­˜ä¸­çš„åƒåœ¾å¯¹è±¡è¾ƒå¤šï¼Œéœ€è¦å¤åˆ¶çš„å¯¹è±¡å°±è¾ƒå°‘ï¼Œè¿™ç§æƒ…å†µä¸‹é€‚åˆä½¿ç”¨è¯¥æ–¹å¼å¹¶ä¸”æ•ˆç‡æ¯”è¾ƒé«˜ï¼Œåä¹‹ï¼Œåˆ™ä¸é€‚åˆã€‚ 

![image-20230506111919008](./assets/image-20230506111919008.png)



1ï¼‰å°†å†…å­˜åŒºåŸŸåˆ†æˆä¸¤éƒ¨åˆ†ï¼Œæ¯æ¬¡æ“ä½œå…¶ä¸­ä¸€ä¸ªã€‚

2ï¼‰å½“è¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œå°†æ­£åœ¨ä½¿ç”¨çš„å†…å­˜åŒºåŸŸä¸­çš„å­˜æ´»å¯¹è±¡ç§»åŠ¨åˆ°æœªä½¿ç”¨çš„å†…å­˜åŒºåŸŸã€‚å½“ç§»åŠ¨å®Œå¯¹è¿™éƒ¨åˆ†å†…å­˜åŒºåŸŸä¸€æ¬¡æ€§æ¸…é™¤ã€‚

3ï¼‰å‘¨è€Œå¤å§‹ã€‚

ä¼˜ç‚¹ï¼š

- åœ¨åƒåœ¾å¯¹è±¡å¤šçš„æƒ…å†µä¸‹ï¼Œæ•ˆç‡è¾ƒé«˜
- æ¸…ç†åï¼Œå†…å­˜æ— ç¢ç‰‡

ç¼ºç‚¹ï¼š

- åˆ†é…çš„2å—å†…å­˜ç©ºé—´ï¼Œåœ¨åŒä¸€ä¸ªæ—¶åˆ»ï¼Œåªèƒ½ä½¿ç”¨ä¸€åŠï¼Œå†…å­˜ä½¿ç”¨ç‡è¾ƒä½

#### 3.3.3 æ ‡è®°æ•´ç†ç®—æ³•

â€‹	æ ‡è®°å‹ç¼©ç®—æ³•æ˜¯åœ¨æ ‡è®°æ¸…é™¤ç®—æ³•çš„åŸºç¡€ä¹‹ä¸Šï¼Œåšäº†ä¼˜åŒ–æ”¹è¿›çš„ç®—æ³•ã€‚å’Œæ ‡è®°æ¸…é™¤ç®—æ³•ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå¯¹å¯¹è±¡çš„å¼•ç”¨è¿›è¡Œæ ‡è®°ï¼Œåœ¨æ¸…ç†é˜¶æ®µï¼Œå¹¶ä¸æ˜¯ç®€å•çš„ç›´æ¥æ¸…ç†å¯å›æ”¶å¯¹è±¡ï¼Œè€Œæ˜¯å°†å­˜æ´»å¯¹è±¡éƒ½å‘å†…å­˜å¦ä¸€ç«¯ç§»åŠ¨ï¼Œç„¶åæ¸…ç†è¾¹ç•Œä»¥å¤–çš„åƒåœ¾ï¼Œä»è€Œè§£å†³äº†ç¢ç‰‡åŒ–çš„é—®é¢˜ã€‚

![image-20230506111957793](./assets/image-20230506111957793.png)

1ï¼‰æ ‡è®°åƒåœ¾ã€‚

2ï¼‰éœ€è¦æ¸…é™¤å‘å³è¾¹èµ°ï¼Œä¸éœ€è¦æ¸…é™¤çš„å‘å·¦è¾¹èµ°ã€‚

3ï¼‰æ¸…é™¤è¾¹ç•Œä»¥å¤–çš„åƒåœ¾ã€‚

ä¼˜ç¼ºç‚¹åŒæ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œè§£å†³äº†æ ‡è®°æ¸…é™¤ç®—æ³•çš„ç¢ç‰‡åŒ–çš„é—®é¢˜ï¼ŒåŒæ—¶ï¼Œæ ‡è®°å‹ç¼©ç®—æ³•å¤šäº†ä¸€æ­¥ï¼Œå¯¹è±¡ç§»åŠ¨å†…å­˜ä½ç½®çš„æ­¥éª¤ï¼Œå…¶æ•ˆç‡ä¹Ÿæœ‰æœ‰ä¸€å®šçš„å½±å“ã€‚

ä¸å¤åˆ¶ç®—æ³•å¯¹æ¯”ï¼šå¤åˆ¶ç®—æ³•æ ‡è®°å®Œå°±å¤åˆ¶ï¼Œä½†æ ‡è®°æ•´ç†ç®—æ³•å¾—ç­‰æŠŠæ‰€æœ‰å­˜æ´»å¯¹è±¡éƒ½æ ‡è®°å®Œæ¯•ï¼Œå†è¿›è¡Œæ•´ç†

### 3.4 åˆ†ä»£æ”¶é›†ç®—æ³•

#### 3.4.1 æ¦‚è¿°

åœ¨java8æ—¶ï¼Œå †è¢«åˆ†ä¸ºäº†ä¸¤ä»½ï¼š**æ–°ç”Ÿä»£å’Œè€å¹´ä»£ã€1ï¼š2ã€‘**ï¼Œåœ¨java7æ—¶ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ªæ°¸ä¹…ä»£ã€‚

![image-20230506131229649](./assets/image-20230506131229649.png)

å¯¹äºæ–°ç”Ÿä»£ï¼Œå†…éƒ¨åˆè¢«åˆ†ä¸ºäº†ä¸‰ä¸ªåŒºåŸŸã€‚EdenåŒºï¼ŒS0åŒºï¼ŒS1åŒºã€8ï¼š1ï¼š1ã€‘

å½“å¯¹æ–°ç”Ÿä»£äº§ç”ŸGCï¼šMinorGCã€young GCã€‘

å½“å¯¹è€å¹´ä»£ä»£äº§ç”ŸGCï¼šMajor GC 

å½“å¯¹æ–°ç”Ÿä»£å’Œè€å¹´ä»£äº§ç”ŸFullGCï¼š æ–°ç”Ÿä»£ + è€å¹´ä»£å®Œæ•´åƒåœ¾å›æ”¶ï¼Œæš‚åœæ—¶é—´é•¿ï¼Œ**åº”å°½åŠ›é¿å…**

#### 3.4.2å·¥ä½œæœºåˆ¶

![image-20230506131308654](./assets/image-20230506131308654.png)

- æ–°åˆ›å»ºçš„å¯¹è±¡ï¼Œéƒ½ä¼šå…ˆåˆ†é…åˆ°edenåŒº

![image-20230506131415418](./assets/image-20230506131415418.png)

- å½“ä¼Šç”¸å›­å†…å­˜ä¸è¶³ï¼Œæ ‡è®°ä¼Šç”¸å›­ä¸ fromï¼ˆç°é˜¶æ®µæ²¡æœ‰ï¼‰çš„å­˜æ´»å¯¹è±¡

- å°†å­˜æ´»å¯¹è±¡é‡‡ç”¨å¤åˆ¶ç®—æ³•å¤åˆ¶åˆ° to ä¸­ï¼Œå¤åˆ¶å®Œæ¯•åï¼Œä¼Šç”¸å›­å’Œ from å†…å­˜éƒ½å¾—åˆ°é‡Šæ”¾

![image-20230506131442503](./assets/image-20230506131442503.png)

- ç»è¿‡ä¸€æ®µæ—¶é—´åä¼Šç”¸å›­çš„å†…å­˜åˆå‡ºç°ä¸è¶³ï¼Œæ ‡è®°edenåŒºåŸŸtoåŒºå­˜æ´»çš„å¯¹è±¡ï¼Œå°†å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°fromåŒº

![image-20230506131544447](./assets/image-20230506131544447.png)

![image-20230506131607645](./assets/image-20230506131607645.png)

- å½“å¹¸å­˜åŒºå¯¹è±¡ç†¬è¿‡å‡ æ¬¡å›æ”¶ï¼ˆæœ€å¤š15æ¬¡ï¼‰ï¼Œæ™‹å‡åˆ°è€å¹´ä»£ï¼ˆå¹¸å­˜åŒºå†…å­˜ä¸è¶³æˆ–å¤§å¯¹è±¡ä¼šå¯¼è‡´æå‰æ™‹å‡ï¼‰

**MinorGCã€ Mixed GC ã€ FullGCçš„åŒºåˆ«æ˜¯ä»€ä¹ˆ**

![image-20230506131640893](./assets/image-20230506131640893.png)

- MinorGCã€young GCã€‘å‘ç”Ÿåœ¨æ–°ç”Ÿä»£çš„åƒåœ¾å›æ”¶ï¼Œæš‚åœæ—¶é—´çŸ­ï¼ˆSTWï¼‰

- Mixed GC æ–°ç”Ÿä»£ + è€å¹´ä»£éƒ¨åˆ†åŒºåŸŸçš„åƒåœ¾å›æ”¶ï¼ŒG1 æ”¶é›†å™¨ç‰¹æœ‰

- FullGCï¼š æ–°ç”Ÿä»£ + è€å¹´ä»£å®Œæ•´åƒåœ¾å›æ”¶ï¼Œæš‚åœæ—¶é—´é•¿ï¼ˆSTWï¼‰ï¼Œåº”å°½åŠ›é¿å…ï¼Ÿ

>åè¯è§£é‡Šï¼š
>
>STWï¼ˆStop-The-Worldï¼‰ï¼šæš‚åœæ‰€æœ‰åº”ç”¨ç¨‹åºçº¿ç¨‹ï¼Œç­‰å¾…åƒåœ¾å›æ”¶çš„å®Œæˆ

### 3.5 è¯´ä¸€ä¸‹ JVM æœ‰å“ªäº›åƒåœ¾å›æ”¶å™¨ï¼Ÿ

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†â˜†

åœ¨jvmä¸­ï¼Œå®ç°äº†å¤šç§åƒåœ¾æ”¶é›†å™¨ï¼ŒåŒ…æ‹¬ï¼š

- ä¸²è¡Œåƒåœ¾æ”¶é›†å™¨

- å¹¶è¡Œåƒåœ¾æ”¶é›†å™¨

- CMSï¼ˆå¹¶å‘ï¼‰åƒåœ¾æ”¶é›†å™¨

- G1åƒåœ¾æ”¶é›†å™¨

#### 3.5.1 ä¸²è¡Œåƒåœ¾æ”¶é›†å™¨

Serialå’ŒSerial Oldä¸²è¡Œåƒåœ¾æ”¶é›†å™¨ï¼Œæ˜¯æŒ‡ä½¿ç”¨å•çº¿ç¨‹è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå †å†…å­˜è¾ƒå°ï¼Œé€‚åˆä¸ªäººç”µè„‘

- Serial ä½œç”¨äºæ–°ç”Ÿä»£ï¼Œé‡‡ç”¨å¤åˆ¶ç®—æ³•

- Serial Old ä½œç”¨äºè€å¹´ä»£ï¼Œé‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•

åƒåœ¾å›æ”¶æ—¶ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œï¼Œå¹¶ä¸”javaåº”ç”¨ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½è¦æš‚åœï¼ˆSTWï¼‰ï¼Œç­‰å¾…åƒåœ¾å›æ”¶çš„å®Œæˆã€‚

![image-20230506154006266](./assets/image-20230506154006266.png)



#### 3.5.2 å¹¶è¡Œåƒåœ¾æ”¶é›†å™¨

Parallel Newå’ŒParallel Oldæ˜¯ä¸€ä¸ªå¹¶è¡Œåƒåœ¾å›æ”¶å™¨ï¼Œ**JDK8é»˜è®¤ä½¿ç”¨æ­¤åƒåœ¾å›æ”¶å™¨**

- Parallel Newä½œç”¨äºæ–°ç”Ÿä»£ï¼Œé‡‡ç”¨å¤åˆ¶ç®—æ³•

- Parallel Oldä½œç”¨äºè€å¹´ä»£ï¼Œé‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•

åƒåœ¾å›æ”¶æ—¶ï¼Œå¤šä¸ªçº¿ç¨‹åœ¨å·¥ä½œï¼Œå¹¶ä¸”javaåº”ç”¨ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½è¦æš‚åœï¼ˆSTWï¼‰ï¼Œç­‰å¾…åƒåœ¾å›æ”¶çš„å®Œæˆã€‚

![image-20230506154042673](./assets/image-20230506154042673.png)

#### 3.5.2 CMSï¼ˆå¹¶å‘ï¼‰åƒåœ¾æ”¶é›†å™¨

CMSå…¨ç§° Concurrent Mark Sweepï¼Œæ˜¯ä¸€æ¬¾å¹¶å‘çš„ã€ä½¿ç”¨æ ‡è®°-æ¸…é™¤ç®—æ³•çš„åƒåœ¾å›æ”¶å™¨ï¼Œè¯¥å›æ”¶å™¨æ˜¯é’ˆå¯¹è€å¹´ä»£åƒåœ¾å›æ”¶çš„ï¼Œæ˜¯ä¸€æ¬¾ä»¥è·å–æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´ä¸ºç›®æ ‡çš„æ”¶é›†å™¨ï¼Œåœé¡¿æ—¶é—´çŸ­ï¼Œç”¨æˆ·ä½“éªŒå°±å¥½ã€‚å…¶æœ€å¤§ç‰¹ç‚¹æ˜¯åœ¨è¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œåº”ç”¨ä»ç„¶èƒ½æ­£å¸¸è¿è¡Œã€‚

![image-20230506154117857](./assets/image-20230506154117857.png)

![image-20230506154107944](./assets/image-20230506154107944.png)

### 3.6 è¯¦ç»†èŠä¸€ä¸‹G1åƒåœ¾å›æ”¶å™¨

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†â˜†

#### 3.6.1 æ¦‚è¿°

- åº”ç”¨äºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œ**åœ¨****JDK9****ä¹‹åé»˜è®¤ä½¿ç”¨****G1**

- åˆ’åˆ†æˆå¤šä¸ªåŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸéƒ½å¯ä»¥å……å½“ edenï¼Œsurvivorï¼Œoldï¼Œ humongousï¼Œå…¶ä¸­ humongous ä¸“ä¸ºå¤§å¯¹è±¡å‡†å¤‡

- é‡‡ç”¨å¤åˆ¶ç®—æ³•

- å“åº”æ—¶é—´ä¸ååé‡å…¼é¡¾

- åˆ†æˆä¸‰ä¸ªé˜¶æ®µï¼šæ–°ç”Ÿä»£å›æ”¶ã€å¹¶å‘æ ‡è®°ã€æ··åˆæ”¶é›†

- å¦‚æœå¹¶å‘å¤±è´¥ï¼ˆå³å›æ”¶é€Ÿåº¦èµ¶ä¸ä¸Šåˆ›å»ºæ–°å¯¹è±¡é€Ÿåº¦ï¼‰ï¼Œä¼šè§¦å‘ Full GC

![image-20230506154323950](./assets/image-20230506154323950.png)

#### 3.6.2 Young Collection(å¹´è½»ä»£åƒåœ¾å›æ”¶)

- åˆå§‹æ—¶ï¼Œæ‰€æœ‰åŒºåŸŸéƒ½å¤„äºç©ºé—²çŠ¶æ€

  ![image-20230506154542687](./assets/image-20230506154542687.png)

- åˆ›å»ºäº†ä¸€äº›å¯¹è±¡ï¼ŒæŒ‘å‡ºä¸€äº›ç©ºé—²åŒºåŸŸä½œä¸ºä¼Šç”¸å›­åŒºå­˜å‚¨è¿™äº›å¯¹è±¡

  ![image-20230506154607558](./assets/image-20230506154607558.png)

- å½“ä¼Šç”¸å›­éœ€è¦åƒåœ¾å›æ”¶æ—¶ï¼ŒæŒ‘å‡ºä¸€ä¸ªç©ºé—²åŒºåŸŸä½œä¸ºå¹¸å­˜åŒºï¼Œç”¨å¤åˆ¶ç®—æ³•å¤åˆ¶å­˜æ´»å¯¹è±¡ï¼Œéœ€è¦æš‚åœç”¨æˆ·çº¿ç¨‹

  ![image-20230506154633118](./assets/image-20230506154633118.png)

  ![image-20230506154705088](./assets/image-20230506154705088.png)

- éšç€æ—¶é—´æµé€ï¼Œä¼Šç”¸å›­çš„å†…å­˜åˆæœ‰ä¸è¶³

- å°†ä¼Šç”¸å›­ä»¥åŠä¹‹å‰å¹¸å­˜åŒºä¸­çš„å­˜æ´»å¯¹è±¡ï¼Œé‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œå¤åˆ¶åˆ°æ–°çš„å¹¸å­˜åŒºï¼Œå…¶ä¸­è¾ƒè€å¯¹è±¡æ™‹å‡è‡³è€å¹´ä»£

  ![image-20230506154759809](./assets/image-20230506154759809.png)

  ![image-20230506154826981](./assets/image-20230506154826981.png)

  ![image-20230506154859985](./assets/image-20230506154859985.png)

  

#### 3.6.3 Young Collection + Concurrent Mark (å¹´è½»ä»£åƒåœ¾å›æ”¶+å¹¶å‘æ ‡è®°) 

å½“è€å¹´ä»£å ç”¨å†…å­˜è¶…è¿‡é˜ˆå€¼(é»˜è®¤æ˜¯45%)åï¼Œè§¦å‘å¹¶å‘æ ‡è®°ï¼Œè¿™æ—¶æ— éœ€æš‚åœç”¨æˆ·çº¿ç¨‹

![image-20230506155000503](./assets/image-20230506155000503.png)

- å¹¶å‘æ ‡è®°ä¹‹åï¼Œä¼šæœ‰é‡æ–°æ ‡è®°é˜¶æ®µè§£å†³æ¼æ ‡é—®é¢˜ï¼Œæ­¤æ—¶éœ€è¦æš‚åœç”¨æˆ·çº¿ç¨‹ã€‚

- è¿™äº›éƒ½å®Œæˆåå°±çŸ¥é“äº†è€å¹´ä»£æœ‰å“ªäº›å­˜æ´»å¯¹è±¡ï¼Œéšåè¿›å…¥æ··åˆæ”¶é›†é˜¶æ®µã€‚æ­¤æ—¶ä¸ä¼šå¯¹æ‰€æœ‰è€å¹´ä»£åŒºåŸŸè¿›è¡Œå›æ”¶ï¼Œè€Œæ˜¯æ ¹æ®æš‚åœæ—¶é—´ç›®æ ‡ä¼˜å…ˆå›æ”¶ä»·å€¼é«˜ï¼ˆå­˜æ´»å¯¹è±¡å°‘ï¼‰çš„åŒºåŸŸï¼ˆè¿™ä¹Ÿæ˜¯ Gabage First åç§°çš„ç”±æ¥ï¼‰ã€‚

  ![image-20230506155047765](./assets/image-20230506155047765.png)

  

#### 3.6.4 Mixed Collection (æ··åˆåƒåœ¾å›æ”¶) 

å¤åˆ¶å®Œæˆï¼Œå†…å­˜å¾—åˆ°é‡Šæ”¾ã€‚è¿›å…¥ä¸‹ä¸€è½®çš„æ–°ç”Ÿä»£å›æ”¶ã€å¹¶å‘æ ‡è®°ã€æ··åˆæ”¶é›†

![image-20230506155116267](./assets/image-20230506155116267.png)

å…¶ä¸­Hå«åšå·¨å‹å¯¹è±¡ï¼Œå¦‚æœå¯¹è±¡éå¸¸å¤§ï¼Œä¼šå¼€è¾Ÿä¸€å—è¿ç»­çš„ç©ºé—´å­˜å‚¨å·¨å‹å¯¹è±¡

![image-20230506155146370](./assets/image-20230506155146370.png)

### 3.7 å¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨çš„åŒºåˆ«ï¼Ÿ

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†

#### 3.7.1 å¼ºå¼•ç”¨

å¼ºå¼•ç”¨ï¼šåªæœ‰æ‰€æœ‰ GC Roots å¯¹è±¡éƒ½ä¸é€šè¿‡ã€å¼ºå¼•ç”¨ã€‘å¼•ç”¨è¯¥å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ‰èƒ½è¢«åƒåœ¾å›æ”¶

```java
User user = new User();
```

![image-20230506155341703](./assets/image-20230506155341703.png)

#### 3.7.2 è½¯å¼•ç”¨

è½¯å¼•ç”¨ï¼šä»…æœ‰è½¯å¼•ç”¨å¼•ç”¨è¯¥å¯¹è±¡æ—¶ï¼Œåœ¨åƒåœ¾å›æ”¶åï¼Œå†…å­˜ä»ä¸è¶³æ—¶ä¼šå†æ¬¡å‡ºå‘åƒåœ¾å›æ”¶

```java
User user = new User();
SoftReference softReference = new SoftReference(user);
```

![image-20230506155416293](./assets/image-20230506155416293.png)

#### 3.7.3 å¼±å¼•ç”¨

å¼±å¼•ç”¨ï¼šä»…æœ‰å¼±å¼•ç”¨å¼•ç”¨è¯¥å¯¹è±¡æ—¶ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶ï¼Œæ— è®ºå†…å­˜æ˜¯å¦å……è¶³ï¼Œéƒ½ä¼šå›æ”¶å¼±å¼•ç”¨å¯¹è±¡

```java
User user = new User();
WeakReference weakReference = new WeakReference(user);
```

![image-20230506155501557](./assets/image-20230506155501557.png)

>å»¶ä¼¸è¯é¢˜ï¼šThreadLocalå†…å­˜æ³„æ¼é—®é¢˜

ThreadLocalç”¨çš„å°±æ˜¯å¼±å¼•ç”¨ï¼Œçœ‹ä»¥ä¸‹æºç ï¼š

```java
static class Entry extends WeakReference<ThreadLocal<?>> {
    Object value;

    Entry(ThreadLocal<?> k, Object v) {
         super(k);
         value = v; //å¼ºå¼•ç”¨ï¼Œä¸ä¼šè¢«å›æ”¶
     }
}
```

`Entry`çš„keyæ˜¯å½“å‰ThreadLocalï¼Œvalueå€¼æ˜¯æˆ‘ä»¬è¦è®¾ç½®çš„æ•°æ®ã€‚

`WeakReference`è¡¨ç¤ºçš„æ˜¯å¼±å¼•ç”¨ï¼Œå½“JVMè¿›è¡ŒGCæ—¶ï¼Œä¸€æ—¦å‘ç°äº†åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸ç®¡å½“å‰å†…å­˜ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå›æ”¶å®ƒçš„å†…å­˜ã€‚ä½†æ˜¯`value`æ˜¯å¼ºå¼•ç”¨ï¼Œå®ƒä¸ä¼šè¢«å›æ”¶æ‰ã€‚

>ThreadLocalä½¿ç”¨å»ºè®®ï¼šä½¿ç”¨å®Œæ¯•åæ³¨æ„è°ƒç”¨æ¸…ç†æ–¹æ³•ã€‚

#### 3.7.4 è™šå¼•ç”¨

è™šå¼•ç”¨ï¼šå¿…é¡»é…åˆå¼•ç”¨é˜Ÿåˆ—ä½¿ç”¨ï¼Œè¢«å¼•ç”¨å¯¹è±¡å›æ”¶æ—¶ï¼Œä¼šå°†è™šå¼•ç”¨å…¥é˜Ÿï¼Œç”± Reference Handler çº¿ç¨‹è°ƒç”¨è™šå¼•ç”¨ç›¸å…³æ–¹æ³•é‡Šæ”¾ç›´æ¥å†…å­˜

![image-20230506155518510](./assets/image-20230506155518510.png)

![image-20230506155552693](./assets/image-20230506155552693.png)

## 4 JVMå®è·µï¼ˆè°ƒä¼˜ï¼‰

### 4.1 JVM è°ƒä¼˜çš„å‚æ•°å¯ä»¥åœ¨å“ªé‡Œè®¾ç½®å‚æ•°å€¼ï¼Ÿ

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†

#### 4.1.1 tomcatçš„è®¾ç½®vmå‚æ•°

ä¿®æ”¹TOMCAT_HOME/bin/catalina.shæ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾

`JAVA_OPTS="-Xms512m -Xmx1024m" `

![image-20220904151948778](./assets/image-20220904151948778.png)

#### 4.1.2 springbooté¡¹ç›®jaræ–‡ä»¶å¯åŠ¨

é€šå¸¸åœ¨linuxç³»ç»Ÿä¸‹ç›´æ¥åŠ å‚æ•°å¯åŠ¨springbooté¡¹ç›®

```sh
nohup java -Xms512m -Xmx1024m -jar xxxx.jar --spring.profiles.active=prod &
```

>nohup  :  ç”¨äºåœ¨ç³»ç»Ÿåå°ä¸æŒ‚æ–­åœ°è¿è¡Œå‘½ä»¤ï¼Œé€€å‡ºç»ˆç«¯ä¸ä¼šå½±å“ç¨‹åºçš„è¿è¡Œ
>
>å‚æ•° **&**  ï¼šè®©å‘½ä»¤åœ¨åå°æ‰§è¡Œï¼Œç»ˆç«¯é€€å‡ºåå‘½ä»¤ä»æ—§æ‰§è¡Œã€‚

### 4.2 ç”¨çš„ JVM è°ƒä¼˜çš„å‚æ•°éƒ½æœ‰å“ªäº›ï¼Ÿ

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†â˜†

â€‹	å¯¹äºJVMè°ƒä¼˜ï¼Œä¸»è¦å°±æ˜¯è°ƒæ•´å¹´è½»ä»£ã€å¹´è€å¤§ã€å…ƒç©ºé—´çš„å†…å­˜ç©ºé—´å¤§å°åŠä½¿ç”¨çš„åƒåœ¾å›æ”¶å™¨ç±»å‹ã€‚

https://www.oracle.com/java/technologies/javase/vmoptions-jsp.html

1ï¼‰è®¾ç½®å †çš„åˆå§‹å¤§å°å’Œæœ€å¤§å¤§å°ï¼Œä¸ºäº†é˜²æ­¢åƒåœ¾æ”¶é›†å™¨åœ¨åˆå§‹å¤§å°ã€æœ€å¤§å¤§å°ä¹‹é—´æ”¶ç¼©å †è€Œäº§ç”Ÿé¢å¤–çš„æ—¶é—´ï¼Œé€šå¸¸æŠŠæœ€å¤§ã€åˆå§‹å¤§å°è®¾ç½®ä¸ºç›¸åŒçš„å€¼ã€‚

```
-Xmsï¼šè®¾ç½®å †çš„åˆå§‹åŒ–å¤§å°

-Xmxï¼šè®¾ç½®å †çš„æœ€å¤§å¤§å°
```

2ï¼‰ è®¾ç½®å¹´è½»ä»£ä¸­EdenåŒºå’Œä¸¤ä¸ªSurvivoråŒºçš„å¤§å°æ¯”ä¾‹ã€‚è¯¥å€¼å¦‚æœä¸è®¾ç½®ï¼Œåˆ™é»˜è®¤æ¯”ä¾‹ä¸º8:1:1ã€‚Javaå®˜æ–¹é€šè¿‡å¢å¤§EdenåŒºçš„å¤§å°ï¼Œæ¥å‡å°‘YGCå‘ç”Ÿçš„æ¬¡æ•°ï¼Œä½†æœ‰æ—¶æˆ‘ä»¬å‘ç°ï¼Œè™½ç„¶æ¬¡æ•°å‡å°‘äº†ï¼Œä½†EdenåŒºæ»¡

çš„æ—¶å€™ï¼Œç”±äºå ç”¨çš„ç©ºé—´è¾ƒå¤§ï¼Œå¯¼è‡´é‡Šæ”¾ç¼“æ…¢ï¼Œæ­¤æ—¶STWçš„æ—¶é—´è¾ƒé•¿ï¼Œå› æ­¤éœ€è¦æŒ‰ç…§ç¨‹åºæƒ…å†µå»è°ƒä¼˜ã€‚

```
-XXSurvivorRatio=3ï¼Œè¡¨ç¤ºå¹´è½»ä»£ä¸­çš„åˆ†é…æ¯”ç‡ï¼šsurvivor:eden = 2:3
```

3ï¼‰å¹´è½»ä»£å’Œè€å¹´ä»£é»˜è®¤æ¯”ä¾‹ä¸º1ï¼š2ã€‚å¯ä»¥é€šè¿‡è°ƒæ•´äºŒè€…ç©ºé—´å¤§å°æ¯”ç‡æ¥è®¾ç½®ä¸¤è€…çš„å¤§å°ã€‚

```
-XX:newSize   è®¾ç½®å¹´è½»ä»£çš„åˆå§‹å¤§å°
-XX:MaxNewSize   è®¾ç½®å¹´è½»ä»£çš„æœ€å¤§å¤§å°ï¼Œ  åˆå§‹å¤§å°å’Œæœ€å¤§å¤§å°ä¸¤ä¸ªå€¼é€šå¸¸ç›¸åŒ
```

4ï¼‰çº¿ç¨‹å †æ ˆçš„è®¾ç½®ï¼š**æ¯ä¸ªçº¿ç¨‹é»˜è®¤ä¼šå¼€å¯1Mçš„å †æ ˆ**ï¼Œç”¨äºå­˜æ”¾æ ˆå¸§ã€è°ƒç”¨å‚æ•°ã€å±€éƒ¨å˜é‡ç­‰ï¼Œä½†ä¸€èˆ¬256Kå°±å¤Ÿç”¨ã€‚é€šå¸¸å‡å°‘æ¯ä¸ªçº¿ç¨‹çš„å †æ ˆï¼Œå¯ä»¥äº§ç”Ÿæ›´å¤šçš„çº¿ç¨‹ï¼Œä½†è¿™å®é™…ä¸Šè¿˜å—é™äºæ“ä½œç³»ç»Ÿã€‚

```
-Xss   å¯¹æ¯ä¸ªçº¿ç¨‹stackå¤§å°çš„è°ƒæ•´,-Xss128k
```

5ï¼‰ä¸€èˆ¬æ¥è¯´ï¼Œå½“survivoråŒºä¸å¤Ÿå¤§æˆ–è€…å ç”¨é‡è¾¾åˆ°50%ï¼Œå°±ä¼šæŠŠä¸€äº›å¯¹è±¡æ”¾åˆ°è€å¹´åŒºã€‚é€šè¿‡è®¾ç½®åˆç†çš„edenåŒºï¼ŒsurvivoråŒºåŠä½¿ç”¨ç‡ï¼Œå¯ä»¥å°†å¹´è½»å¯¹è±¡ä¿å­˜åœ¨å¹´è½»ä»£ï¼Œä»è€Œé¿å…full GCï¼Œä½¿ç”¨-Xmnè®¾ç½®å¹´è½»ä»£çš„å¤§å°

6ï¼‰ç³»ç»ŸCPUæŒç»­é£™é«˜çš„è¯ï¼Œé¦–å…ˆå…ˆæ’æŸ¥ä»£ç é—®é¢˜ï¼Œå¦‚æœä»£ç æ²¡é—®é¢˜ï¼Œåˆ™å’¨è¯¢è¿ç»´æˆ–è€…äº‘æœåŠ¡å™¨ä¾›åº”å•†ï¼Œé€šå¸¸æœåŠ¡å™¨é‡å¯æˆ–è€…æœåŠ¡å™¨è¿ç§»å³å¯è§£å†³ã€‚

7ï¼‰å¯¹äºå ç”¨å†…å­˜æ¯”è¾ƒå¤šçš„å¤§å¯¹è±¡ï¼Œä¸€èˆ¬ä¼šé€‰æ‹©åœ¨è€å¹´ä»£åˆ†é…å†…å­˜ã€‚å¦‚æœåœ¨å¹´è½»ä»£ç»™å¤§å¯¹è±¡åˆ†é…å†…å­˜ï¼Œå¹´è½»ä»£å†…å­˜ä¸å¤Ÿäº†ï¼Œå°±è¦åœ¨edenåŒºç§»åŠ¨å¤§é‡å¯¹è±¡åˆ°è€å¹´ä»£ï¼Œç„¶åè¿™äº›ç§»åŠ¨çš„å¯¹è±¡å¯èƒ½å¾ˆå¿«æ¶ˆäº¡ï¼Œå› æ­¤å¯¼è‡´full GCã€‚é€šè¿‡è®¾ç½®å‚æ•°ï¼š-XX:PetenureSizeThreshold=1000000ï¼Œå•ä½ä¸ºBï¼Œæ ‡æ˜å¯¹è±¡å¤§å°è¶…è¿‡1Mæ—¶ï¼Œåœ¨è€å¹´ä»£(tenured)åˆ†é…å†…å­˜ç©ºé—´ã€‚

8ï¼‰ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¹´è½»å¯¹è±¡æ”¾åœ¨edenåŒºï¼Œå½“ç¬¬ä¸€æ¬¡GCåï¼Œå¦‚æœå¯¹è±¡è¿˜å­˜æ´»ï¼Œæ”¾åˆ°survivoråŒºï¼Œæ­¤åï¼Œæ¯GCä¸€æ¬¡ï¼Œå¹´é¾„å¢åŠ 1ï¼Œå½“å¯¹è±¡çš„å¹´é¾„è¾¾åˆ°é˜ˆå€¼ï¼Œå°±è¢«æ”¾åˆ°tenuredè€å¹´åŒºã€‚è¿™ä¸ªé˜ˆå€¼å¯ä»¥åŒæ„-XX:MaxTenuringThresholdè®¾ç½®ã€‚å¦‚æœæƒ³è®©å¯¹è±¡ç•™åœ¨å¹´è½»ä»£ï¼Œå¯ä»¥è®¾ç½®æ¯”è¾ƒå¤§çš„é˜ˆå€¼ã€‚

```
ï¼ˆ1ï¼‰-XX:+UseParallelGC:å¹´è½»ä»£ä½¿ç”¨å¹¶è¡Œåƒåœ¾å›æ”¶æ”¶é›†å™¨ã€‚è¿™æ˜¯ä¸€ä¸ªå…³æ³¨ååé‡çš„æ”¶é›†å™¨ï¼Œå¯ä»¥å°½å¯èƒ½çš„å‡å°‘åƒåœ¾å›æ”¶æ—¶é—´ã€‚

ï¼ˆ2ï¼‰-XX:+UseParallelOldGC:è®¾ç½®è€å¹´ä»£ä½¿ç”¨å¹¶è¡Œåƒåœ¾å›æ”¶æ”¶é›†å™¨ã€‚
```

9ï¼‰å°è¯•ä½¿ç”¨å¤§çš„å†…å­˜åˆ†é¡µï¼šä½¿ç”¨å¤§çš„å†…å­˜åˆ†é¡µå¢åŠ CPUçš„å†…å­˜å¯»å€èƒ½åŠ›ï¼Œä»è€Œç³»ç»Ÿçš„æ€§èƒ½ã€‚

```
-XX:+LargePageSizeInBytes è®¾ç½®å†…å­˜é¡µçš„å¤§å°
```

10ï¼‰ä½¿ç”¨éå ç”¨çš„åƒåœ¾æ”¶é›†å™¨ã€‚

```
-XX:+UseConcMarkSweepGCè€å¹´ä»£ä½¿ç”¨CMSæ”¶é›†å™¨é™ä½åœé¡¿ã€‚
```

### 4.3 è¯´ä¸€ä¸‹ JVM è°ƒä¼˜çš„å·¥å…·ï¼Ÿ

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†â˜†

#### 4.3.1 å‘½ä»¤å·¥å…·

##### 4.3.1.1 jpsï¼ˆJava Process Statusï¼‰

è¾“å‡ºJVMä¸­è¿è¡Œçš„è¿›ç¨‹çŠ¶æ€ä¿¡æ¯(ç°åœ¨ä¸€èˆ¬ä½¿ç”¨jconsole)

![image-20220904104739581](./assets/image-20220904104739581.png)

##### 4.3.1.2 jstack

æŸ¥çœ‹javaè¿›ç¨‹å†…**çº¿ç¨‹çš„å †æ ˆ**ä¿¡æ¯ã€‚

```sh
jstack [option] <pid>  
```

javaæ¡ˆä¾‹

```java
package com.heima.jvm;

public class Application {

    public static void main(String[] args) throws InterruptedException {
        while (true){
            Thread.sleep(1000);
            System.out.println("å“ˆå“ˆå“ˆ");
        }
    }
}

```

ä½¿ç”¨jstackæŸ¥çœ‹è¿›è¡Œå †æ ˆè¿è¡Œä¿¡æ¯

![image-20220904111059602](./assets/image-20220904111059602.png)

##### 4.3.1.3 jmap

ç”¨äºç”Ÿæˆå †è½¬å­˜å¿«ç…§

> jmap [options] pid  å†…å­˜æ˜ åƒä¿¡æ¯
>
> jmap -heap pid   æ˜¾ç¤ºJavaå †çš„ä¿¡æ¯
>
> jmap -dump:format=b,file=heap.hprof pid
>
> â€‹		format=bè¡¨ç¤ºä»¥hprofäºŒè¿›åˆ¶æ ¼å¼è½¬å‚¨Javaå †çš„å†…å­˜
> â€‹		file=< filename >ç”¨äºæŒ‡å®šå¿«ç…§dumpæ–‡ä»¶çš„æ–‡ä»¶åã€‚

ä¾‹ï¼šæ˜¾ç¤ºäº†æŸä¸€ä¸ªjavaè¿è¡Œçš„å †ä¿¡æ¯

```java
C:\Users\yuhon>jmap -heap 53280
Attaching to process ID 53280, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is 25.321-b07

using thread-local object allocation.
Parallel GC with 8 thread(s)   //å¹¶è¡Œçš„åƒåœ¾å›æ”¶å™¨

Heap Configuration:  //å †é…ç½®
   MinHeapFreeRatio         = 0   //ç©ºé—²å †ç©ºé—´çš„æœ€å°ç™¾åˆ†æ¯”
   MaxHeapFreeRatio         = 100  //ç©ºé—²å †ç©ºé—´çš„æœ€å¤§ç™¾åˆ†æ¯”
   MaxHeapSize              = 8524922880 (8130.0MB) //å †ç©ºé—´å…è®¸çš„æœ€å¤§å€¼
   NewSize                  = 178257920 (170.0MB) //æ–°ç”Ÿä»£å †ç©ºé—´çš„é»˜è®¤å€¼
   MaxNewSize               = 2841640960 (2710.0MB) //æ–°ç”Ÿä»£å †ç©ºé—´å…è®¸çš„æœ€å¤§å€¼
   OldSize                  = 356515840 (340.0MB) //è€å¹´ä»£å †ç©ºé—´çš„é»˜è®¤å€¼
   NewRatio                 = 2 //æ–°ç”Ÿä»£ä¸è€å¹´ä»£çš„å †ç©ºé—´æ¯”å€¼ï¼Œè¡¨ç¤ºæ–°ç”Ÿä»£ï¼šè€å¹´ä»£=1ï¼š2
   SurvivorRatio            = 8 //ä¸¤ä¸ªSurvivoråŒºå’ŒEdenåŒºçš„å †ç©ºé—´æ¯”å€¼ä¸º8,è¡¨ç¤ºS0:S1:Eden=1:1:8
   MetaspaceSize            = 21807104 (20.796875MB) //å…ƒç©ºé—´çš„é»˜è®¤å€¼
   CompressedClassSpaceSize = 1073741824 (1024.0MB) //å‹ç¼©ç±»ä½¿ç”¨ç©ºé—´å¤§å°
   MaxMetaspaceSize         = 17592186044415 MB //å…ƒç©ºé—´å…è®¸çš„æœ€å¤§å€¼
   G1HeapRegionSize         = 0 (0.0MB)//åœ¨ä½¿ç”¨ G1 åƒåœ¾å›æ”¶ç®—æ³•æ—¶ï¼ŒJVM ä¼šå°† Heap ç©ºé—´åˆ†éš”ä¸ºè‹¥å¹²ä¸ª Regionï¼Œè¯¥å‚æ•°ç”¨æ¥æŒ‡å®šæ¯ä¸ª Region ç©ºé—´çš„å¤§å°ã€‚

Heap Usage:
PS Young Generation
Eden Space: //Edenä½¿ç”¨æƒ…å†µ
   capacity = 134217728 (128.0MB)
   used     = 10737496 (10.240074157714844MB)
   free     = 123480232 (117.75992584228516MB)
   8.000057935714722% used
From Space: //Survivor-From ä½¿ç”¨æƒ…å†µ
   capacity = 22020096 (21.0MB)
   used     = 0 (0.0MB)
   free     = 22020096 (21.0MB)
   0.0% used
To Space: //Survivor-To ä½¿ç”¨æƒ…å†µ
   capacity = 22020096 (21.0MB)
   used     = 0 (0.0MB)
   free     = 22020096 (21.0MB)
   0.0% used
PS Old Generation  //è€å¹´ä»£ ä½¿ç”¨æƒ…å†µ
   capacity = 356515840 (340.0MB)
   used     = 0 (0.0MB)
   free     = 356515840 (340.0MB)
   0.0% used

3185 interned Strings occupying 261264 bytes.
```



##### 4.3.1.4 jhat

ç”¨äºåˆ†æjmapç”Ÿæˆçš„å †è½¬å­˜å¿«ç…§ï¼ˆä¸€èˆ¬ä¸æ¨èä½¿ç”¨ï¼Œè€Œæ˜¯ä½¿ç”¨Ecplise Memory Analyzerï¼‰

##### 4.3.1.5 jstat

æ˜¯JVMç»Ÿè®¡ç›‘æµ‹å·¥å…·ã€‚å¯ä»¥ç”¨æ¥æ˜¾ç¤ºåƒåœ¾å›æ”¶ä¿¡æ¯ã€ç±»åŠ è½½ä¿¡æ¯ã€æ–°ç”Ÿä»£ç»Ÿè®¡ä¿¡æ¯ç­‰ã€‚

**å¸¸è§å‚æ•°**ï¼š

â‘ æ€»ç»“åƒåœ¾å›æ”¶ç»Ÿè®¡

```sh
jstat -gcutil pid
```

![image-20220904114511854](./assets/image-20220904114511854.png)

| å­—æ®µ | å«ä¹‰                   |
| ---- | ---------------------- |
| S0   | å¹¸å­˜1åŒºå½“å‰ä½¿ç”¨æ¯”ä¾‹    |
| S1   | å¹¸å­˜2åŒºå½“å‰ä½¿ç”¨æ¯”ä¾‹    |
| E    | ä¼Šç”¸å›­åŒºä½¿ç”¨æ¯”ä¾‹       |
| O    | è€å¹´ä»£ä½¿ç”¨æ¯”ä¾‹         |
| M    | å…ƒæ•°æ®åŒºä½¿ç”¨æ¯”ä¾‹       |
| CCS  | å‹ç¼©ä½¿ç”¨æ¯”ä¾‹           |
| YGC  | å¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•°     |
| YGCT | å¹´è½»ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´ |
| FGC  | è€å¹´ä»£åƒåœ¾å›æ”¶æ¬¡æ•°     |
| FGCT | è€å¹´ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´ |
| GCT  | åƒåœ¾å›æ”¶æ¶ˆè€—æ€»æ—¶é—´     |

â‘¡åƒåœ¾å›æ”¶ç»Ÿè®¡

```sh
jstat -gc pid
```

![image-20220904115157363](./assets/image-20220904115157363.png)

#### 4.3.2 å¯è§†åŒ–å·¥å…·

##### 4.3.2.1 jconsole

ç”¨äºå¯¹jvmçš„å†…å­˜ï¼Œçº¿ç¨‹ï¼Œç±» çš„ç›‘æ§ï¼Œæ˜¯ä¸€ä¸ªåŸºäº jmx çš„ GUI æ€§èƒ½ç›‘æ§å·¥å…·

æ‰“å¼€æ–¹å¼ï¼šjava å®‰è£…ç›®å½• binç›®å½•ä¸‹ ç›´æ¥å¯åŠ¨ jconsole.exe å°±è¡Œ

![image-20220904115936095](./assets/image-20220904115936095.png)

å¯ä»¥å†…å­˜ã€çº¿ç¨‹ã€ç±»ç­‰ä¿¡æ¯

![image-20220904120057211](./assets/image-20220904120057211.png)



##### 4.3.2.2 VisualVMï¼šæ•…éšœå¤„ç†å·¥å…·

èƒ½å¤Ÿç›‘æ§çº¿ç¨‹ï¼Œå†…å­˜æƒ…å†µï¼ŒæŸ¥çœ‹æ–¹æ³•çš„CPUæ—¶é—´å’Œå†…å­˜ä¸­çš„å¯¹ è±¡ï¼Œå·²è¢«GCçš„å¯¹è±¡ï¼Œåå‘æŸ¥çœ‹åˆ†é…çš„å †æ ˆ

æ‰“å¼€æ–¹å¼ï¼šjava å®‰è£…ç›®å½• binç›®å½•ä¸‹ ç›´æ¥å¯åŠ¨ jvisualvm.exeå°±è¡Œ

![image-20220904120356174](./assets/image-20220904120356174.png)

ç›‘æ§ç¨‹åºè¿è¡Œæƒ…å†µ

![image-20220904132011289](./assets/image-20220904132011289.png)

æŸ¥çœ‹è¿è¡Œä¸­çš„dump

![image-20220904132134095](./assets/image-20220904132134095.png)

æŸ¥çœ‹å †ä¸­çš„ä¿¡æ¯

![image-20220904132346495](./assets/image-20220904132346495.png)

### 4.4 javaå†…å­˜æ³„éœ²çš„æ’æŸ¥æ€è·¯ï¼Ÿ

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†â˜†

åŸå› ï¼š

å¦‚æœçº¿ç¨‹è¯·æ±‚åˆ†é…çš„æ ˆå®¹é‡è¶…è¿‡javaè™šæ‹Ÿæœºæ ˆå…è®¸çš„æœ€å¤§å®¹é‡çš„æ—¶å€™ï¼Œjavaè™šæ‹Ÿæœºå°†æŠ›å‡ºä¸€ä¸ªStackOverFlowErrorå¼‚å¸¸

å¦‚æœjavaè™šæ‹Ÿæœºæ ˆå¯ä»¥åŠ¨æ€æ‹“å±•ï¼Œå¹¶ä¸”æ‰©å±•çš„åŠ¨ä½œå·²ç»å°è¯•è¿‡ï¼Œä½†æ˜¯ç›®å‰æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜å»å®Œæˆæ‹“å±•ï¼Œæˆ–è€…åœ¨å»ºç«‹æ–°çº¿ç¨‹çš„æ—¶å€™æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å»åˆ›å»ºå¯¹åº”çš„è™šæ‹Ÿæœºæ ˆï¼Œé‚£javaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ªOutOfMemoryErrorå¼‚å¸¸

å¦‚æœä¸€æ¬¡åŠ è½½çš„ç±»å¤ªå¤šï¼Œå…ƒç©ºé—´å†…å­˜ä¸è¶³ï¼Œåˆ™ä¼šæŠ¥OutOfMemoryError: Metaspace

![image-20230506155704119](./assets/image-20230506155704119.png)



1ã€é€šè¿‡jmapæŒ‡å®šæ‰“å°ä»–çš„å†…å­˜å¿«ç…§ dump

>æœ‰çš„æƒ…å†µæ˜¯å†…å­˜æº¢å‡ºä¹‹åç¨‹åºåˆ™ä¼šç›´æ¥ä¸­æ–­ï¼Œè€Œjmapåªèƒ½æ‰“å°åœ¨è¿è¡Œä¸­çš„ç¨‹åºï¼Œæ‰€ä»¥å»ºè®®é€šè¿‡å‚æ•°çš„æ–¹å¼çš„ç”Ÿæˆdumpæ–‡ä»¶ï¼Œé…ç½®å¦‚ä¸‹ï¼š
>
>-XX:+HeapDumpOnOutOfMemoryError
>-XX:HeapDumpPath=/home/app/dumps/      æŒ‡å®šç”Ÿæˆåæ–‡ä»¶çš„ä¿å­˜ç›®å½•

2ã€é€šè¿‡å·¥å…·ï¼Œ VisualVMï¼ˆEcplise MATï¼‰å»åˆ†æ dumpæ–‡ä»¶

VisualVMå¯ä»¥åŠ è½½ç¦»çº¿çš„dumpæ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾

æ–‡ä»¶-->è£…å…¥--->é€‰æ‹©dumpæ–‡ä»¶å³å¯æŸ¥çœ‹å †å¿«ç…§ä¿¡æ¯

>å¦‚æœæ˜¯linuxç³»ç»Ÿä¸­çš„ç¨‹åºï¼Œåˆ™éœ€è¦æŠŠdumpæ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°ï¼ˆwindowsç¯å¢ƒï¼‰ä¸‹ï¼Œæ‰“å¼€VisualVMå·¥å…·åˆ†æã€‚VisualVMç›®å‰åªæ”¯æŒåœ¨windowsç¯å¢ƒä¸‹è¿è¡Œå¯è§†åŒ–

![image-20220904132925812](./assets/image-20220904132925812.png)

3ã€é€šè¿‡æŸ¥çœ‹å †ä¿¡æ¯çš„æƒ…å†µï¼Œå¯ä»¥å¤§æ¦‚å®šä½å†…å­˜æº¢å‡ºæ˜¯å“ªè¡Œä»£ç å‡ºäº†é—®é¢˜

![image-20220904133722905](./assets/image-20220904133722905.png)

4ã€æ‰¾åˆ°å¯¹åº”çš„ä»£ç ï¼Œé€šè¿‡é˜…è¯»ä¸Šä¸‹æ–‡çš„æƒ…å†µï¼Œè¿›è¡Œä¿®å¤å³å¯

### 4.5 CPUé£™é«˜æ’æŸ¥æ–¹æ¡ˆä¸æ€è·¯ï¼Ÿ

>éš¾æ˜“ç¨‹åº¦ï¼šâ˜†â˜†â˜†â˜†
>
>å‡ºç°é¢‘ç‡ï¼šâ˜†â˜†â˜†â˜†

1.ä½¿ç”¨topå‘½ä»¤æŸ¥çœ‹å ç”¨cpuçš„æƒ…å†µ

![image-20220904161818255](./assets/image-20220904161818255.png)

2.é€šè¿‡topå‘½ä»¤æŸ¥çœ‹åï¼Œå¯ä»¥æŸ¥çœ‹æ˜¯å“ªä¸€ä¸ªè¿›ç¨‹å ç”¨cpuè¾ƒé«˜ï¼Œä¸Šå›¾æ‰€ç¤ºçš„è¿›ç¨‹ä¸ºï¼š30978

3.æŸ¥çœ‹å½“å‰çº¿ç¨‹ä¸­çš„è¿›ç¨‹ä¿¡æ¯

```sh
ps H -eo pid,tid,%cpu | grep 40940
```

>pid  è¿›è¡Œid
>
>tid   è¿›ç¨‹ä¸­çš„çº¿ç¨‹id
>
>%  cpuä½¿ç”¨ç‡ 

![image-20220904162117022](./assets/image-20220904162117022.png)

4.é€šè¿‡ä¸Šå›¾åˆ†æï¼Œåœ¨è¿›ç¨‹30978ä¸­çš„çº¿ç¨‹30979å ç”¨cpuè¾ƒé«˜

>æ³¨æ„ï¼šä¸Šè¿°çš„çº¿ç¨‹idæ˜¯ä¸€ä¸ªåè¿›åˆ¶ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¿™ä¸ªçº¿ç¨‹idè½¬æ¢ä¸º16è¿›åˆ¶æ‰è¡Œï¼Œå› ä¸ºé€šå¸¸åœ¨æ—¥å¿—ä¸­å±•ç¤ºçš„éƒ½æ˜¯16è¿›åˆ¶çš„çº¿ç¨‹idåç§°
>
>è½¬æ¢æ–¹å¼ï¼š
>
>åœ¨linuxä¸­æ‰§è¡Œå‘½ä»¤
>
>`printf "%x\n" 30979`
>
>![image-20220904162654928](./assets/image-20220904162654928.png)

5.å¯ä»¥æ ¹æ®çº¿ç¨‹ id æ‰¾åˆ°æœ‰é—®é¢˜çš„çº¿ç¨‹ï¼Œè¿›ä¸€æ­¥å®šä½åˆ°é—®é¢˜ä»£ç çš„æºç è¡Œå·

æ‰§è¡Œå‘½ä»¤

```sh
jstack 30978   æ­¤å¤„æ˜¯è¿›ç¨‹id
```

![image-20220904162941977](./assets/image-20220904162941977.png)



## 5.é¢è¯•ç°åœº

### 5.1 JVMç»„æˆ

>**é¢è¯•å®˜**ï¼šJVMç”±é‚£äº›éƒ¨åˆ†ç»„æˆï¼Œè¿è¡Œæµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ
>
>**å€™é€‰äºº:**
>
>å—¯ï¼Œå¥½çš„~~
>
>åœ¨JVMä¸­å…±æœ‰å››å¤§éƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯ClassLoaderï¼ˆç±»åŠ è½½å™¨ï¼‰ã€Runtime Data Areaï¼ˆè¿è¡Œæ—¶æ•°æ®åŒºï¼Œå†…å­˜åˆ†åŒºï¼‰ã€Execution Engineï¼ˆæ‰§è¡Œå¼•æ“ï¼‰ã€Native Method Libraryï¼ˆæœ¬åœ°åº“æ¥å£ï¼‰
>
>å®ƒä»¬çš„è¿è¡Œæµç¨‹æ˜¯ï¼š
>
>ç¬¬ä¸€ï¼Œç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰æŠŠJavaä»£ç è½¬æ¢ä¸ºå­—èŠ‚ç 
>
>ç¬¬äºŒï¼Œè¿è¡Œæ—¶æ•°æ®åŒºï¼ˆRuntime Data Areaï¼‰æŠŠå­—èŠ‚ç åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè€Œå­—èŠ‚ç æ–‡ä»¶åªæ˜¯JVMçš„ä¸€å¥—æŒ‡ä»¤é›†è§„èŒƒï¼Œå¹¶ä¸èƒ½ç›´æ¥äº¤ç»™åº•å±‚ç³»ç»Ÿå»æ‰§è¡Œï¼Œè€Œæ˜¯æœ‰æ‰§è¡Œå¼•æ“è¿è¡Œ
>
>ç¬¬ä¸‰ï¼Œæ‰§è¡Œå¼•æ“ï¼ˆExecution Engineï¼‰å°†å­—èŠ‚ç ç¿»è¯‘ä¸ºåº•å±‚ç³»ç»ŸæŒ‡ä»¤ï¼Œå†äº¤ç”±CPUæ‰§è¡Œå»æ‰§è¡Œï¼Œæ­¤æ—¶éœ€è¦è°ƒç”¨å…¶ä»–è¯­è¨€çš„æœ¬åœ°åº“æ¥å£ï¼ˆNative Method Libraryï¼‰æ¥å®ç°æ•´ä¸ªç¨‹åºçš„åŠŸèƒ½ã€‚
>
>**é¢è¯•å®˜**ï¼šå¥½çš„ï¼Œä½ èƒ½è¯¦ç»†è¯´ä¸€ä¸‹ JVM è¿è¡Œæ—¶æ•°æ®åŒºå—ï¼Ÿ
>
>**å€™é€‰äºº:**
>
>å—¯ï¼Œå¥½~
>
>è¿è¡Œæ—¶æ•°æ®åŒºåŒ…å«äº†å †ã€æ–¹æ³•åŒºã€æ ˆã€æœ¬åœ°æ–¹æ³•æ ˆã€ç¨‹åºè®¡æ•°å™¨è¿™å‡ éƒ¨åˆ†ï¼Œæ¯ä¸ªåŠŸèƒ½ä½œç”¨ä¸ä¸€æ ·ã€‚
>
>- å †è§£å†³çš„æ˜¯å¯¹è±¡å®ä¾‹å­˜å‚¨çš„é—®é¢˜ï¼Œåƒåœ¾å›æ”¶å™¨ç®¡ç†çš„ä¸»è¦åŒºåŸŸã€‚
>- æ–¹æ³•åŒºå¯ä»¥è®¤ä¸ºæ˜¯å †çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ä¿¡æ¯ï¼Œå¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ã€‚
>- æ ˆè§£å†³çš„æ˜¯ç¨‹åºè¿è¡Œçš„é—®é¢˜ï¼Œæ ˆé‡Œé¢å­˜çš„æ˜¯æ ˆå¸§ï¼Œæ ˆå¸§é‡Œé¢å­˜çš„æ˜¯å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚
>- æœ¬åœ°æ–¹æ³•æ ˆä¸æ ˆåŠŸèƒ½ç›¸åŒï¼Œæœ¬åœ°æ–¹æ³•æ ˆæ‰§è¡Œçš„æ˜¯æœ¬åœ°æ–¹æ³•ï¼Œä¸€ä¸ªJavaè°ƒç”¨éJavaä»£ç çš„æ¥å£ã€‚
>- ç¨‹åºè®¡æ•°å™¨ï¼ˆPCå¯„å­˜å™¨ï¼‰ç¨‹åºè®¡æ•°å™¨ä¸­å­˜æ”¾çš„æ˜¯å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œæ•°ã€‚JVMå·¥ä½œæ—¶å°±æ˜¯é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€ä¸ªéœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚
>
>**é¢è¯•å®˜**ï¼šå¥½çš„ï¼Œä½ å†è¯¦ç»†ä»‹ç»ä¸€ä¸‹ç¨‹åºè®¡æ•°å™¨çš„ä½œç”¨ï¼Ÿ
>
>**å€™é€‰äºº:**
>
>å—¯ï¼Œæ˜¯è¿™æ ·~~
>
>javaè™šæ‹Ÿæœºå¯¹äºå¤šçº¿ç¨‹æ˜¯é€šè¿‡çº¿ç¨‹è½®æµåˆ‡æ¢å¹¶ä¸”åˆ†é…çº¿ç¨‹æ‰§è¡Œæ—¶é—´ã€‚åœ¨ä»»ä½•çš„ä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œä¸€ä¸ªå¤„ç†å™¨åªä¼šå¤„ç†æ‰§è¡Œä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœå½“å‰è¢«æ‰§è¡Œçš„è¿™ä¸ªçº¿ç¨‹å®ƒæ‰€åˆ†é…çš„æ‰§è¡Œæ—¶é—´ç”¨å®Œäº†ã€æŒ‚èµ·ã€‘ã€‚å¤„ç†å™¨ä¼šåˆ‡æ¢åˆ°å¦å¤–çš„ä¸€ä¸ªçº¿ç¨‹ä¸Šæ¥è¿›è¡Œæ‰§è¡Œã€‚å¹¶ä¸”è¿™ä¸ªçº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ç”¨å®Œäº†ï¼Œæ¥ç€å¤„ç†å™¨å°±ä¼šåˆæ¥æ‰§è¡Œè¢«æŒ‚èµ·çš„è¿™ä¸ªçº¿ç¨‹ã€‚è¿™æ—¶å€™ç¨‹åºè®¡æ•°å™¨å°±èµ·åˆ°äº†å…³é”®ä½œç”¨ï¼Œç¨‹åºè®¡æ•°å™¨åœ¨æ¥å›åˆ‡æ¢çš„çº¿ç¨‹ä¸­è®°å½•ä»–ä¸Šä¸€æ¬¡æ‰§è¡Œçš„è¡Œå·ï¼Œç„¶åæ¥ç€ç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚
>
>**é¢è¯•å®˜**ï¼šä½ èƒ½ç»™æˆ‘è¯¦ç»†çš„ä»‹ç»Javaå †å—?
>
>**å€™é€‰äºº:**
>
>å¥½çš„~
>
>Javaä¸­çš„å †æœ¯è¯­çº¿ç¨‹å…±äº«çš„åŒºåŸŸã€‚ä¸»è¦ç”¨æ¥ä¿å­˜**å¯¹è±¡å®ä¾‹ï¼Œæ•°ç»„**ç­‰ï¼Œå½“å †ä¸­æ²¡æœ‰å†…å­˜ç©ºé—´å¯åˆ†é…ç»™å®ä¾‹ï¼Œä¹Ÿæ— æ³•å†æ‰©å±•æ—¶ï¼Œåˆ™æŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚
>
>â€‹	åœ¨JAVA8ä¸­å †å†…ä¼šå­˜åœ¨å¹´è½»ä»£ã€è€å¹´ä»£
>
>â€‹	1ï¼‰YoungåŒºè¢«åˆ’åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼ŒEdenåŒºå’Œä¸¤ä¸ªå¤§å°ä¸¥æ ¼ç›¸åŒçš„SurvivoråŒºï¼Œå…¶ä¸­ï¼ŒSurvivoråŒºé—´ä¸­ï¼ŒæŸä¸€æ—¶åˆ»åªæœ‰å…¶ä¸­ä¸€ä¸ªæ˜¯è¢«ä½¿ç”¨çš„ï¼Œå¦å¤–ä¸€ä¸ªç•™åšåƒåœ¾æ”¶é›†æ—¶å¤åˆ¶å¯¹è±¡ç”¨ã€‚åœ¨EdenåŒºå˜æ»¡çš„æ—¶å€™ï¼Œ GCå°±ä¼šå°†å­˜æ´»çš„å¯¹è±¡ç§»åˆ°ç©ºé—²çš„SurvivoråŒºé—´ä¸­ï¼Œæ ¹æ®JVMçš„ç­–ç•¥ï¼Œåœ¨ç»è¿‡å‡ æ¬¡åƒåœ¾æ”¶é›†åï¼Œä»»ç„¶å­˜æ´»äºSurvivorçš„å¯¹è±¡å°†è¢«ç§»åŠ¨åˆ°TenuredåŒºé—´ã€‚
>
>â€‹	2ï¼‰TenuredåŒºä¸»è¦ä¿å­˜ç”Ÿå‘½å‘¨æœŸé•¿çš„å¯¹è±¡ï¼Œä¸€èˆ¬æ˜¯ä¸€äº›è€çš„å¯¹è±¡ï¼Œå½“ä¸€äº›å¯¹è±¡åœ¨Youngå¤åˆ¶è½¬ç§»ä¸€å®šçš„æ¬¡æ•°ä»¥åï¼Œå¯¹è±¡å°±ä¼šè¢«è½¬ç§»åˆ°TenuredåŒºã€‚
>
>**é¢è¯•å®˜**ï¼šèƒ½ä¸èƒ½è§£é‡Šä¸€ä¸‹æ–¹æ³•åŒºï¼Ÿ
>
>**å€™é€‰äºº:**
>
>å¥½çš„~
>
>ä¸è™šæ‹Ÿæœºæ ˆç±»ä¼¼ã€‚æœ¬åœ°æ–¹æ³•æ ˆæ˜¯ä¸ºè™šæ‹Ÿæœº**æ‰§è¡Œæœ¬åœ°æ–¹æ³•æ—¶æä¾›æœåŠ¡çš„**ã€‚ä¸éœ€è¦è¿›è¡ŒGCã€‚æœ¬åœ°æ–¹æ³•ä¸€èˆ¬æ˜¯ç”±å…¶ä»–è¯­è¨€ç¼–å†™ã€‚
>
>**é¢è¯•å®˜**ï¼šä½ å¬è¿‡ç›´æ¥å†…å­˜å—ï¼Ÿ
>
>**å€™é€‰äºº:**
>
>å—¯~~
>
>å®ƒåˆå«åš**å †å¤–å†…å­˜**ï¼Œ**çº¿ç¨‹å…±äº«çš„åŒºåŸŸ**ï¼Œåœ¨ Java 8 ä¹‹å‰æœ‰ä¸ª**æ°¸ä¹…ä»£**çš„æ¦‚å¿µï¼Œå®é™…ä¸ŠæŒ‡çš„æ˜¯ HotSpot è™šæ‹Ÿæœºä¸Šçš„æ°¸ä¹…ä»£ï¼Œå®ƒç”¨æ°¸ä¹…ä»£å®ç°äº† JVM è§„èŒƒå®šä¹‰çš„æ–¹æ³•åŒºåŠŸèƒ½ï¼Œ**ä¸»è¦å­˜å‚¨ç±»çš„ä¿¡æ¯ï¼Œå¸¸é‡ï¼Œé™æ€å˜é‡**ï¼Œå³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åä»£ç ç­‰ï¼Œè¿™éƒ¨åˆ†ç”±äºæ˜¯åœ¨å †ä¸­å®ç°çš„ï¼Œå— GC çš„ç®¡ç†ï¼Œä¸è¿‡ç”±äºæ°¸ä¹…ä»£æœ‰ -XX:MaxPermSize çš„ä¸Šé™ï¼Œæ‰€ä»¥å¦‚æœå¤§é‡åŠ¨æ€ç”Ÿæˆç±»ï¼ˆå°†ç±»ä¿¡æ¯æ”¾å…¥æ°¸ä¹…ä»£ï¼‰ï¼Œå¾ˆå®¹æ˜“é€ æˆ OOMï¼Œæœ‰äººè¯´å¯ä»¥æŠŠæ°¸ä¹…ä»£è®¾ç½®å¾—è¶³å¤Ÿå¤§ï¼Œä½†å¾ˆéš¾ç¡®å®šä¸€ä¸ªåˆé€‚çš„å¤§å°ï¼Œå—ç±»æ•°é‡ï¼Œå¸¸é‡æ•°é‡çš„å¤šå°‘å½±å“å¾ˆå¤§ã€‚
>
>â€‹	æ‰€ä»¥åœ¨ Java 8 ä¸­å°±æŠŠæ–¹æ³•åŒºçš„å®ç°ç§»åˆ°äº†æœ¬åœ°å†…å­˜ä¸­çš„å…ƒç©ºé—´ä¸­ï¼Œè¿™æ ·æ–¹æ³•åŒºå°±ä¸å— JVM çš„æ§åˆ¶äº†,ä¹Ÿå°±ä¸ä¼šè¿›è¡Œ GCï¼Œä¹Ÿå› æ­¤æå‡äº†æ€§èƒ½ã€‚
>
>**é¢è¯•å®˜**ï¼šä»€ä¹ˆæ˜¯è™šæ‹Ÿæœºæ ˆ
>
>**å€™é€‰äºº:**
>
>è™šæ‹Ÿæœºæ ˆæ˜¯æè¿°çš„æ˜¯æ–¹æ³•æ‰§è¡Œæ—¶çš„å†…å­˜æ¨¡å‹,æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ç›¸åŒ,æ¯ä¸ªæ–¹æ³•è¢«æ‰§è¡Œçš„åŒæ—¶ä¼šåˆ›å»º**æ ˆæ¡¢**ã€‚ä¿å­˜æ‰§è¡Œæ–¹æ³•æ—¶çš„**å±€éƒ¨å˜é‡ã€åŠ¨æ€è¿æ¥ä¿¡æ¯ã€æ–¹æ³•è¿”å›åœ°å€ä¿¡æ¯**ç­‰ç­‰ã€‚æ–¹æ³•å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ä¼šè¿›æ ˆï¼Œæ–¹æ³•æ‰§è¡Œå®Œä¼šå‡ºæ ˆã€ç›¸å½“äºæ¸…ç©ºäº†æ•°æ®ã€‘ï¼Œæ‰€ä»¥è¿™å—åŒºåŸŸ**ä¸éœ€è¦è¿›è¡Œ GC**ã€‚
>
>**é¢è¯•å®˜**ï¼šèƒ½è¯´ä¸€ä¸‹å †æ ˆçš„åŒºåˆ«æ˜¯ä»€ä¹ˆå—ï¼Ÿ
>
>**å€™é€‰äºº:**
>
>å—¯ï¼Œå¥½çš„ï¼Œæœ‰è¿™å‡ ä¸ªåŒºåˆ«
>
>ç¬¬ä¸€ï¼Œæ ˆå†…å­˜ä¸€èˆ¬ä¼šç”¨æ¥å­˜å‚¨å±€éƒ¨å˜é‡å’Œæ–¹æ³•è°ƒç”¨ï¼Œä½†å †å†…å­˜æ˜¯ç”¨æ¥å­˜å‚¨Javaå¯¹è±¡å’Œæ•°ç»„çš„çš„ã€‚å †ä¼šGCåƒåœ¾å›æ”¶ï¼Œè€Œæ ˆä¸ä¼šã€‚
>
>ç¬¬äºŒã€æ ˆå†…å­˜æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œè€Œå †å†…å­˜æ˜¯çº¿ç¨‹å…±æœ‰çš„ã€‚
>
>ç¬¬ä¸‰ã€ä¸¤è€…å¼‚å¸¸é”™è¯¯ä¸åŒï¼Œä½†å¦‚æœæ ˆå†…å­˜æˆ–è€…å †å†…å­˜ä¸è¶³éƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚
>
>æ ˆç©ºé—´ä¸è¶³ï¼šjava.lang.StackOverFlowErrorã€‚
>
>å †ç©ºé—´ä¸è¶³ï¼šjava.lang.OutOfMemoryErrorã€‚

### 5.2 ç±»åŠ è½½å™¨

>**é¢è¯•å®˜**ï¼šä»€ä¹ˆæ˜¯ç±»åŠ è½½å™¨ï¼Œç±»åŠ è½½å™¨æœ‰å“ªäº›?
>
>**å€™é€‰äºº:**
>
>å—¯ï¼Œæ˜¯è¿™æ ·çš„
>
>JVMåªä¼šè¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰çš„ä¸»è¦ä½œç”¨å°±æ˜¯å°†**å­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°JVMä¸­**ï¼Œä»è€Œè®©Javaç¨‹åºèƒ½å¤Ÿå¯åŠ¨èµ·æ¥ã€‚
>
>å¸¸è§çš„ç±»åŠ è½½å™¨æœ‰4ä¸ª
>
>ç¬¬ä¸€ä¸ªæ˜¯å¯åŠ¨ç±»åŠ è½½å™¨(BootStrap ClassLoader)ï¼šå…¶æ˜¯ç”±C++ç¼–å†™å®ç°ã€‚ç”¨äºåŠ è½½JAVA_HOME/jre/libç›®å½•ä¸‹çš„ç±»åº“ã€‚
>
>ç¬¬äºŒä¸ªæ˜¯æ‰©å±•ç±»åŠ è½½å™¨(ExtClassLoader)ï¼šè¯¥ç±»æ˜¯ClassLoaderçš„å­ç±»ï¼Œä¸»è¦åŠ è½½JAVA_HOME/jre/lib/extç›®å½•ä¸­çš„ç±»åº“ã€‚
>
>ç¬¬ä¸‰ä¸ªæ˜¯åº”ç”¨ç±»åŠ è½½å™¨(AppClassLoader)ï¼šè¯¥ç±»æ˜¯ClassLoaderçš„å­ç±»ï¼Œä¸»è¦ç”¨äºåŠ è½½classPathä¸‹çš„ç±»ï¼Œä¹Ÿå°±æ˜¯åŠ è½½å¼€å‘è€…è‡ªå·±ç¼–å†™çš„Javaç±»ã€‚
>
>ç¬¬å››ä¸ªæ˜¯è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼šå¼€å‘è€…è‡ªå®šä¹‰ç±»ç»§æ‰¿ClassLoaderï¼Œå®ç°è‡ªå®šä¹‰ç±»åŠ è½½è§„åˆ™ã€‚
>
>**é¢è¯•å®˜**ï¼šè¯´ä¸€ä¸‹ç±»è£…è½½çš„æ‰§è¡Œè¿‡ç¨‹ï¼Ÿ
>
>**å€™é€‰äºº:**
>
>å—¯ï¼Œè¿™ä¸ªè¿‡ç¨‹è¿˜æ˜¯æŒºå¤šçš„ã€‚
>
>ç±»ä»åŠ è½½åˆ°è™šæ‹Ÿæœºä¸­å¼€å§‹ï¼Œç›´åˆ°å¸è½½ä¸ºæ­¢ï¼Œå®ƒçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬äº†ï¼šåŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€è§£æã€åˆå§‹åŒ–ã€ä½¿ç”¨å’Œå¸è½½è¿™7ä¸ªé˜¶æ®µã€‚å…¶ä¸­ï¼ŒéªŒè¯ã€å‡†å¤‡å’Œè§£æè¿™ä¸‰ä¸ªéƒ¨åˆ†ç»Ÿç§°ä¸ºè¿æ¥ï¼ˆlinkingï¼‰
>
>1.åŠ è½½ï¼šæŸ¥æ‰¾å’Œå¯¼å…¥classæ–‡ä»¶
>
>2.éªŒè¯ï¼šä¿è¯åŠ è½½ç±»çš„å‡†ç¡®æ€§
>
>3.å‡†å¤‡ï¼šä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®ç±»å˜é‡åˆå§‹å€¼
>
>4.è§£æï¼šæŠŠç±»ä¸­çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨
>
>5.åˆå§‹åŒ–ï¼šå¯¹ç±»çš„é™æ€å˜é‡ï¼Œé™æ€ä»£ç å—æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ
>
>6.ä½¿ç”¨ï¼šJVM å¼€å§‹ä»å…¥å£æ–¹æ³•å¼€å§‹æ‰§è¡Œç”¨æˆ·çš„ç¨‹åºä»£ç 
>
>7.å¸è½½ï¼šå½“ç”¨æˆ·ç¨‹åºä»£ç æ‰§è¡Œå®Œæ¯•åï¼ŒJVM ä¾¿å¼€å§‹é”€æ¯åˆ›å»ºçš„ Class å¯¹è±¡ï¼Œæœ€åè´Ÿè´£è¿è¡Œçš„ JVM ä¹Ÿé€€å‡ºå†…å­˜
>
>**é¢è¯•å®˜**ï¼šä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿ
>
>**å€™é€‰äºº:**
>
>å—¯ï¼Œå®ƒæ˜¯æ˜¯è¿™æ ·çš„ã€‚
>
>å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½çš„è¯·æ±‚ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™è¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼Œæ¯ä¸€ä¸ªå±‚æ¬¡çš„ç±»åŠ è½½å™¨éƒ½æ˜¯å¦‚æ­¤ï¼Œå› æ­¤æ‰€æœ‰çš„åŠ è½½è¯·æ±‚æœ€ç»ˆéƒ½åº”è¯¥ä¼ è¯´åˆ°é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ä¸­ï¼Œåªæœ‰å½“çˆ¶ç±»åŠ è½½å™¨è¿”å›è‡ªå·±æ— æ³•å®Œæˆè¿™ä¸ªåŠ è½½è¯·æ±‚ï¼ˆå®ƒçš„æœç´¢è¿”å›ä¸­æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€çš„ç±»ï¼‰æ—¶ï¼Œå­ç±»åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½
>
>**é¢è¯•å®˜**ï¼šJVMä¸ºä»€ä¹ˆé‡‡ç”¨åŒäº²å§”æ´¾æœºåˆ¶
>
>**å€™é€‰äºº:**
>
>ä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ã€‚
>
>ç¬¬ä¸€ã€é€šè¿‡åŒäº²å§”æ´¾æœºåˆ¶å¯ä»¥é¿å…æŸä¸€ä¸ªç±»è¢«é‡å¤åŠ è½½ï¼Œå½“çˆ¶ç±»å·²ç»åŠ è½½ååˆ™æ— éœ€é‡å¤åŠ è½½ï¼Œä¿è¯å”¯ä¸€æ€§ã€‚
>
>ç¬¬äºŒã€ä¸ºäº†å®‰å…¨ï¼Œä¿è¯ç±»åº“APIä¸ä¼šè¢«ä¿®æ”¹

### 5.3 åƒåœ¾å›æ”¶

>**é¢è¯•å®˜**ï¼šç®€è¿°Javaåƒåœ¾å›æ”¶æœºåˆ¶ï¼Ÿï¼ˆGCæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦GCï¼‰
>
>**å€™é€‰äºº:**
>
>å—¯ï¼Œæ˜¯è¿™æ ·~~
>
>ä¸ºäº†è®©ç¨‹åºå‘˜æ›´ä¸“æ³¨äºä»£ç çš„å®ç°ï¼Œè€Œä¸ç”¨è¿‡å¤šçš„è€ƒè™‘å†…å­˜é‡Šæ”¾çš„é—®é¢˜ï¼Œæ‰€ä»¥ï¼Œåœ¨Javaè¯­è¨€ä¸­ï¼Œæœ‰äº†è‡ªåŠ¨çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„GC(Garbage Collection)ã€‚
>
>æœ‰äº†åƒåœ¾å›æ”¶æœºåˆ¶åï¼Œç¨‹åºå‘˜åªéœ€è¦å…³å¿ƒå†…å­˜çš„ç”³è¯·å³å¯ï¼Œå†…å­˜çš„é‡Šæ”¾ç”±ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«å®Œæˆã€‚
>
>åœ¨è¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œä¸åŒçš„å¯¹è±¡å¼•ç”¨ç±»å‹ï¼ŒGCä¼šé‡‡ç”¨ä¸åŒçš„å›æ”¶æ—¶æœº
>
>**é¢è¯•å®˜**ï¼šå¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨çš„åŒºåˆ«ï¼Ÿ
>
>**å€™é€‰äºº:**
>
>å—¯å—¯~
>
>å¼ºå¼•ç”¨æœ€ä¸ºæ™®é€šçš„å¼•ç”¨æ–¹å¼ï¼Œè¡¨ç¤ºä¸€ä¸ªå¯¹è±¡å¤„äº**æœ‰ç”¨ä¸”å¿…é¡»**çš„çŠ¶æ€ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡å…·æœ‰å¼ºå¼•ç”¨ï¼Œåˆ™GCå¹¶ä¸ä¼šå›æ”¶å®ƒã€‚å³ä¾¿å †ä¸­å†…å­˜ä¸è¶³äº†ï¼Œå®å¯å‡ºç°OOMï¼Œä¹Ÿä¸ä¼šå¯¹å…¶è¿›è¡Œå›æ”¶
>
>è½¯å¼•ç”¨è¡¨ç¤ºä¸€ä¸ªå¯¹è±¡å¤„äº**æœ‰ç”¨ä¸”éå¿…é¡»**çŠ¶æ€ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡å¤„äºè½¯å¼•ç”¨ï¼Œåœ¨å†…å­˜ç©ºé—´è¶³å¤Ÿçš„æƒ…å†µä¸‹ï¼ŒGCæœºåˆ¶å¹¶ä¸ä¼šå›æ”¶å®ƒï¼Œè€Œåœ¨å†…å­˜ç©ºé—´ä¸è¶³æ—¶ï¼Œåˆ™ä¼šåœ¨OOMå¼‚å¸¸å‡ºç°ä¹‹é—´å¯¹å…¶è¿›è¡Œå›æ”¶ã€‚ä½†å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºGCçº¿ç¨‹ä¼˜å…ˆçº§è¾ƒä½ï¼Œè½¯å¼•ç”¨å¹¶ä¸ä¼šç«‹å³è¢«å›æ”¶ã€‚
>
>å¼±å¼•ç”¨è¡¨ç¤ºä¸€ä¸ªå¯¹è±¡å¤„äº**å¯èƒ½æœ‰ç”¨ä¸”éå¿…é¡»**çš„çŠ¶æ€ã€‚åœ¨GCçº¿ç¨‹æ‰«æå†…å­˜åŒºåŸŸæ—¶ï¼Œä¸€æ—¦å‘ç°å¼±å¼•ç”¨ï¼Œå°±ä¼šå›æ”¶åˆ°å¼±å¼•ç”¨ç›¸å…³è”çš„å¯¹è±¡ã€‚å¯¹äºå¼±å¼•ç”¨çš„å›æ”¶ï¼Œæ— å…³å†…å­˜åŒºåŸŸæ˜¯å¦è¶³å¤Ÿï¼Œä¸€æ—¦å‘ç°åˆ™ä¼šè¢«å›æ”¶ã€‚åŒæ ·çš„ï¼Œå› ä¸ºGCçº¿ç¨‹ä¼˜å…ˆçº§è¾ƒä½ï¼Œæ‰€ä»¥å¼±å¼•ç”¨ä¹Ÿå¹¶ä¸æ˜¯ä¼šè¢«ç«‹åˆ»å›æ”¶ã€‚
>
>è™šå¼•ç”¨è¡¨ç¤ºä¸€ä¸ªå¯¹è±¡å¤„äº**æ— ç”¨**çš„çŠ¶æ€ã€‚åœ¨ä»»ä½•æ—¶å€™éƒ½æœ‰å¯èƒ½è¢«åƒåœ¾å›æ”¶ã€‚è™šå¼•ç”¨çš„ä½¿ç”¨å¿…é¡»å’Œå¼•ç”¨é˜Ÿåˆ—Reference Queueè”åˆä½¿ç”¨
>
>**é¢è¯•å®˜**ï¼šå¯¹è±¡ä»€ä¹ˆæ—¶å€™å¯ä»¥è¢«åƒåœ¾å™¨å›æ”¶
>
>**å€™é€‰äºº:**
>
>æ€è€ƒä¸€ä¼š~~
>
>å¦‚æœä¸€ä¸ªæˆ–å¤šä¸ªå¯¹è±¡æ²¡æœ‰ä»»ä½•çš„å¼•ç”¨æŒ‡å‘å®ƒäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡ç°åœ¨å°±æ˜¯åƒåœ¾ï¼Œå¦‚æœå®šä½äº†åƒåœ¾ï¼Œåˆ™æœ‰å¯èƒ½ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚
>
>å¦‚æœè¦å®šä½ä»€ä¹ˆæ˜¯åƒåœ¾ï¼Œæœ‰ä¸¤ç§æ–¹å¼æ¥ç¡®å®šï¼Œç¬¬ä¸€ä¸ªæ˜¯å¼•ç”¨è®¡æ•°æ³•ï¼Œç¬¬äºŒä¸ªæ˜¯å¯è¾¾æ€§åˆ†æç®—æ³•
>
>é€šå¸¸éƒ½ä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•æ¥ç¡®å®šæ˜¯ä¸æ˜¯åƒåœ¾
>
>**é¢è¯•å®˜**ï¼š JVM åƒåœ¾å›æ”¶ç®—æ³•æœ‰å“ªäº›ï¼Ÿ
>
>**å€™é€‰äºº:**
>
>æˆ‘è®°å¾—ä¸€å…±æœ‰å››ç§ï¼Œåˆ†åˆ«æ˜¯æ ‡è®°æ¸…é™¤ç®—æ³•ã€å¤åˆ¶ç®—æ³•ã€æ ‡è®°æ•´ç†ç®—æ³•ã€åˆ†ä»£å›æ”¶
>
>**é¢è¯•å®˜**ï¼š ä½ èƒ½è¯¦ç»†èŠä¸€ä¸‹åˆ†ä»£å›æ”¶å—ï¼Ÿ
>
>**å€™é€‰äºº:**
>
>å…³äºåˆ†ä»£å›æ”¶æ˜¯è¿™æ ·çš„
>
>åœ¨java8æ—¶ï¼Œå †è¢«åˆ†ä¸ºäº†ä¸¤ä»½ï¼šæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œå®ƒä»¬é»˜è®¤ç©ºé—´å ç”¨æ¯”ä¾‹æ˜¯1:2
>
>å¯¹äºæ–°ç”Ÿä»£ï¼Œå†…éƒ¨åˆè¢«åˆ†ä¸ºäº†ä¸‰ä¸ªåŒºåŸŸã€‚EdenåŒºï¼ŒS0åŒºï¼ŒS1åŒºé»˜è®¤ç©ºé—´å ç”¨æ¯”ä¾‹æ˜¯8:1:1
>
>å…·ä½“çš„å·¥ä½œæœºåˆ¶æ˜¯æœ‰äº›æƒ…å†µï¼š
>
>1ï¼‰å½“åˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡ä¼šè¢«åˆ†é…åœ¨æ–°ç”Ÿä»£çš„EdenåŒºã€‚å½“EdenåŒºè¦æ»¡äº†æ—¶å€™ï¼Œè§¦å‘YoungGCã€‚
>
>2ï¼‰å½“è¿›è¡ŒYoungGCåï¼Œæ­¤æ—¶åœ¨EdenåŒºå­˜æ´»çš„å¯¹è±¡è¢«ç§»åŠ¨åˆ°S0åŒºï¼Œå¹¶ä¸”**å½“å‰å¯¹è±¡çš„å¹´é¾„ä¼šåŠ 1**ï¼Œæ¸…ç©ºEdenåŒºã€‚
>
>3ï¼‰å½“å†ä¸€æ¬¡è§¦å‘YoungGCçš„æ—¶å€™ï¼Œä¼šæŠŠEdenåŒºä¸­å­˜æ´»ä¸‹æ¥çš„å¯¹è±¡å’ŒS0ä¸­çš„å¯¹è±¡ï¼Œç§»åŠ¨åˆ°S1åŒºä¸­ï¼Œè¿™äº›å¯¹è±¡çš„å¹´é¾„ä¼šåŠ 1ï¼Œæ¸…ç©ºEdenåŒºå’ŒS0åŒºã€‚
>
>4ï¼‰å½“å†ä¸€æ¬¡è§¦å‘YoungGCçš„æ—¶å€™ï¼Œä¼šæŠŠEdenåŒºä¸­å­˜æ´»ä¸‹æ¥çš„å¯¹è±¡å’ŒS1ä¸­çš„å¯¹è±¡ï¼Œç§»åŠ¨åˆ°S0åŒºä¸­ï¼Œè¿™äº›å¯¹è±¡çš„å¹´é¾„ä¼šåŠ 1ï¼Œæ¸…ç©ºEdenåŒºå’ŒS1åŒºã€‚
>
>5ï¼‰å¯¹è±¡çš„å¹´é¾„è¾¾åˆ°äº†æŸä¸€ä¸ªé™å®šçš„å€¼ï¼ˆ**é»˜è®¤15å²**  ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±ä¼šè¿›å…¥åˆ°è€å¹´ä»£ä¸­ã€‚
>
>å½“ç„¶ä¹Ÿæœ‰ç‰¹æ®Šæƒ…å†µï¼Œå¦‚æœè¿›å…¥EdenåŒºçš„æ˜¯ä¸€ä¸ªå¤§å¯¹è±¡ï¼Œåœ¨è§¦å‘YoungGCçš„æ—¶å€™ï¼Œä¼šç›´æ¥å­˜æ”¾åˆ°è€å¹´ä»£
>
>å½“è€å¹´ä»£æ»¡äº†ä¹‹åï¼Œ**è§¦å‘FullGC**ã€‚**FullGCåŒæ—¶å›æ”¶æ–°ç”Ÿä»£å’Œè€å¹´ä»£**ï¼Œå½“å‰åªä¼šå­˜åœ¨ä¸€ä¸ªFullGCçš„çº¿ç¨‹è¿›è¡Œæ‰§è¡Œï¼Œå…¶ä»–çš„çº¿ç¨‹å…¨éƒ¨ä¼šè¢«æŒ‚èµ·ã€‚  æˆ‘ä»¬åœ¨ç¨‹åºä¸­è¦å°½é‡é¿å…FullGCçš„å‡ºç°ã€‚
>
>**é¢è¯•å®˜**ï¼šè®²ä¸€ä¸‹æ–°ç”Ÿä»£ã€è€å¹´ä»£ã€æ°¸ä¹…ä»£çš„åŒºåˆ«ï¼Ÿ
>
>**å€™é€‰äºº:**
>
>å—¯ï¼æ˜¯è¿™æ ·çš„ï¼Œç®€å•è¯´å°±æ˜¯
>
>**æ–°ç”Ÿä»£**ä¸»è¦ç”¨æ¥å­˜æ”¾æ–°ç”Ÿçš„å¯¹è±¡ã€‚
>
>**è€å¹´ä»£**ä¸»è¦å­˜æ”¾åº”ç”¨ä¸­ç”Ÿå‘½å‘¨æœŸé•¿çš„å†…å­˜å¯¹è±¡ã€‚
>
>**æ°¸ä¹…ä»£**æŒ‡çš„æ˜¯æ°¸ä¹…ä¿å­˜åŒºåŸŸã€‚ä¸»è¦å­˜æ”¾Classå’ŒMetaï¼ˆå…ƒæ•°æ®ï¼‰çš„ä¿¡æ¯ã€‚åœ¨Java8ä¸­ï¼Œæ°¸ä¹…ä»£å·²ç»è¢«ç§»é™¤ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ä¸€ä¸ªç§°ä¹‹ä¸ºâ€œå…ƒæ•°æ®åŒºâ€ï¼ˆ**å…ƒç©ºé—´**ï¼‰çš„åŒºåŸŸã€‚å…ƒç©ºé—´å’Œæ°¸ä¹…ä»£ç±»ä¼¼ï¼Œä¸è¿‡å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ã€‚å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜çš„é™åˆ¶ã€‚
>
>**é¢è¯•å®˜**ï¼šè¯´ä¸€ä¸‹ JVM æœ‰å“ªäº›åƒåœ¾å›æ”¶å™¨ï¼Ÿ
>
>**å€™é€‰äºº:**
>
>åœ¨jvmä¸­ï¼Œå®ç°äº†å¤šç§åƒåœ¾æ”¶é›†å™¨ï¼ŒåŒ…æ‹¬ï¼šä¸²è¡Œåƒåœ¾æ”¶é›†å™¨ã€å¹¶è¡Œåƒåœ¾æ”¶é›†å™¨ï¼ˆJDK8é»˜è®¤ï¼‰ã€CMSï¼ˆå¹¶å‘ï¼‰åƒåœ¾æ”¶é›†å™¨ã€G1åƒåœ¾æ”¶é›†å™¨ï¼ˆJDK9é»˜è®¤ï¼‰
>
>**é¢è¯•å®˜**ï¼šMinor GCã€Major GCã€Full GCæ˜¯ä»€ä¹ˆ
>
>**å€™é€‰äºº:**
>
>å—¯ï¼Œå…¶å®å®ƒä»¬æŒ‡çš„æ˜¯ä¸åŒä»£ä¹‹é—´çš„åƒåœ¾å›æ”¶
>
>Minor GC å‘ç”Ÿåœ¨æ–°ç”Ÿä»£çš„åƒåœ¾å›æ”¶ï¼Œæš‚åœæ—¶é—´çŸ­
>
>Major GC è€å¹´ä»£åŒºåŸŸçš„åƒåœ¾å›æ”¶ï¼Œè€å¹´ä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œä¼šå…ˆå°è¯•è§¦å‘Minor GCã€‚Minor GCä¹‹åç©ºé—´è¿˜ä¸è¶³ï¼Œåˆ™ä¼šè§¦å‘Major GCï¼ŒMajor GCé€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œæš‚åœæ—¶é—´é•¿
>
>Full GC æ–°ç”Ÿä»£ + è€å¹´ä»£å®Œæ•´åƒåœ¾å›æ”¶ï¼Œæš‚åœæ—¶é—´é•¿ï¼Œ**åº”å°½åŠ›é¿å…**

### 5.4 JVMå®è·µï¼ˆè°ƒä¼˜ï¼‰

>**é¢è¯•å®˜**ï¼šJVM è°ƒä¼˜çš„å‚æ•°å¯ä»¥åœ¨å“ªé‡Œè®¾ç½®å‚æ•°å€¼ï¼Ÿ
>
>**å€™é€‰äºº:**
>
>æˆ‘ä»¬å½“æ—¶çš„é¡¹ç›®æ˜¯springbooté¡¹ç›®ï¼Œå¯ä»¥åœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™ï¼Œjava -jarä¸­åŠ å…¥å‚æ•°å°±è¡Œäº†
>
>
>
>**é¢è¯•å®˜**ï¼šç”¨çš„ JVM è°ƒä¼˜çš„å‚æ•°éƒ½æœ‰å“ªäº›ï¼Ÿ
>
>**å€™é€‰äºº:**
>
>å—¯ï¼Œè¿™äº›å‚æ•°æ˜¯æ¯”è¾ƒå¤šçš„
>
>æˆ‘è®°å¾—å½“æ—¶æˆ‘ä»¬è®¾ç½®è¿‡å †çš„å¤§å°ï¼Œåƒ-Xmså’Œ-Xmx
>
>è¿˜æœ‰å°±æ˜¯å¯ä»¥è®¾ç½®å¹´è½»ä»£ä¸­EdenåŒºå’Œä¸¤ä¸ªSurvivoråŒºçš„å¤§å°æ¯”ä¾‹
>
>è¿˜æœ‰å°±æ˜¯å¯ä»¥è®¾ç½®ä½¿ç”¨å“ªç§åƒåœ¾å›æ”¶å™¨ç­‰ç­‰ã€‚å…·ä½“çš„æŒ‡ä»¤è¿˜çœŸè®°ä¸å¤ªæ¸…æ¥šã€‚
>
>
>
>**é¢è¯•å®˜**ï¼šå—¯ï¼Œå¥½çš„ï¼Œä½ ä»¬å¹³æ—¶è°ƒè¯• JVMéƒ½ç”¨äº†å“ªäº›å·¥å…·å‘¢ï¼Ÿ
>
>**å€™é€‰äºº:**
>
>å—¯ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨jdkè‡ªå¸¦çš„ä¸€äº›å·¥å…·ï¼Œæ¯”å¦‚
>
>jps è¾“å‡ºJVMä¸­è¿è¡Œçš„è¿›ç¨‹çŠ¶æ€ä¿¡æ¯
>
>jstackæŸ¥çœ‹javaè¿›ç¨‹å†…**çº¿ç¨‹çš„å †æ ˆ**ä¿¡æ¯ã€‚
>
>jmap ç”¨äºç”Ÿæˆå †è½¬å­˜å¿«ç…§
>
>jstatç”¨äºJVMç»Ÿè®¡ç›‘æµ‹å·¥å…·
>
>è¿˜æœ‰ä¸€äº›å¯è§†åŒ–å·¥å…·ï¼Œåƒjconsoleå’ŒVisualVMç­‰
>
>**é¢è¯•å®˜**ï¼šå‡å¦‚é¡¹ç›®ä¸­äº§ç”Ÿäº†javaå†…å­˜æ³„éœ²ï¼Œä½ è¯´ä¸€ä¸‹ä½ çš„æ’æŸ¥æ€è·¯ï¼Ÿ
>
>**å€™é€‰äºº:**
>
>å—¯ï¼Œè¿™ä¸ªæˆ‘åœ¨ä¹‹å‰é¡¹ç›®æ’æŸ¥è¿‡
>
>ç¬¬ä¸€å‘¢å¯ä»¥é€šè¿‡jmapæŒ‡å®šæ‰“å°ä»–çš„å†…å­˜å¿«ç…§ dumpæ–‡ä»¶ï¼Œä¸è¿‡æœ‰çš„æƒ…å†µæ‰“å°ä¸äº†ï¼Œæˆ‘ä»¬ä¼šè®¾ç½®vmå‚æ•°è®©ç¨‹åºè‡ªåŠ¨ç”Ÿæˆdumpæ–‡ä»¶
>
>ç¬¬äºŒï¼Œå¯ä»¥é€šè¿‡å·¥å…·å»åˆ†æ dumpæ–‡ä»¶ï¼Œjdkè‡ªå¸¦çš„VisualVMå°±å¯ä»¥åˆ†æ
>
>ç¬¬ä¸‰ï¼Œé€šè¿‡æŸ¥çœ‹å †ä¿¡æ¯çš„æƒ…å†µï¼Œå¯ä»¥å¤§æ¦‚å®šä½å†…å­˜æº¢å‡ºæ˜¯å“ªè¡Œä»£ç å‡ºäº†é—®é¢˜
>
>ç¬¬å››ï¼Œæ‰¾åˆ°å¯¹åº”çš„ä»£ç ï¼Œé€šè¿‡é˜…è¯»ä¸Šä¸‹æ–‡çš„æƒ…å†µï¼Œè¿›è¡Œä¿®å¤å³å¯
>
>**é¢è¯•å®˜**ï¼šå¥½çš„ï¼Œé‚£ç°åœ¨å†æ¥è¯´ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯è¯´æœåŠ¡å™¨CPUæŒç»­é£™é«˜ï¼Œä½ çš„æ’æŸ¥æ–¹æ¡ˆä¸æ€è·¯ï¼Ÿ
>
>**å€™é€‰äºº:**
>
>å—¯ï¼Œæˆ‘æ€è€ƒä¸€ä¸‹~~
>
>å¯ä»¥è¿™ä¹ˆåš~~
>
>ç¬¬ä¸€å¯ä»¥ä½¿ç”¨ä½¿ç”¨topå‘½ä»¤æŸ¥çœ‹å ç”¨cpuçš„æƒ…å†µ
>
>ç¬¬äºŒé€šè¿‡topå‘½ä»¤æŸ¥çœ‹åï¼Œå¯ä»¥æŸ¥çœ‹æ˜¯å“ªä¸€ä¸ªè¿›ç¨‹å ç”¨cpuè¾ƒé«˜ï¼Œè®°å½•è¿™ä¸ªè¿›ç¨‹id
>
>ç¬¬ä¸‰å¯ä»¥é€šè¿‡ps æŸ¥çœ‹å½“å‰è¿›ç¨‹ä¸­çš„çº¿ç¨‹ä¿¡æ¯ï¼Œçœ‹çœ‹å“ªä¸ªçº¿ç¨‹çš„cpuå ç”¨è¾ƒé«˜
>
>ç¬¬å››å¯ä»¥jstackå‘½ä»¤æ‰“å°è¿›è¡Œçš„idï¼Œæ‰¾åˆ°è¿™ä¸ªçº¿ç¨‹ï¼Œå°±å¯ä»¥è¿›ä¸€æ­¥å®šä½é—®é¢˜ä»£ç çš„è¡Œå·